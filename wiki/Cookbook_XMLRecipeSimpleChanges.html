<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Making_Simple_Changes_to_Element"> Making Simple Changes to Elements or Text </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
You want to filter some XML. For example, you want to make substitutions in the body of a document, or add a genre to every song in described described in an XML document, or you want to change:
<pre>
&lt;book id="1"&gt; to &lt;book&gt;&lt;id&gt;1&lt;/id&gt;&lt;/book&gt;
</pre>
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
The nifty thing about SXML is that the representation is simply a list, so the rules for altering lists apply equally well here.  Here's a quick guide to manipulating tree structures:
1 <code>car</code> gives you the name of a node <code>n</code>.
1 <code>cdr</code> selects the children of a node in the tree.  You can <code>(define children cdr)</code> to make that more obvious.
1 Based on the last rule, the <code>cadr</code> of a node <code>n</code> is is the first child of <code>n</code>.
1 If an element has attributes, the first child will be <code>'@</code>, the list of attributes of a node <code>n</code> will then be <code>(cdr (children n))</code>.
1 When dealing with attributes, the value of the attribute is the <code>cadr</code> of the list representing that attribute.  Therefore, <code>(set-car! (cdr n) "some value")</code> will change the value of an attribute <code>n</code> in place.
1 Given a list of children of a node <code>n</code>, <code>append!</code> will append a child to the end of the list of children.  Rember that the child you're appending has to be a list, if you're appending an entire subtree, you have to wrap it in a list.
1 Given a a node <code>n</code>, you can <code>set-cdr!</code> to the node to replace the children of a node.  If you <code>cons</code> a new node to the <code>cdr</code> or <code>cddr</code> of a node (depending on whether it has attributes), that's the same as adding a child to the beginning of the list of children.
<p />
These rules work a bit differently than DOM: in DOM, children of an element are everything <em>but</em> attributes, attributes have their own access methods.  Here, we're treating attributes more or less on equal footing as other children.  However, this can get you into a little trouble, so later we'll need to take this into account.
<p />
Let's try some examples, starting with a sample document:
<div class="scheme">
  <pre>(<span class="keyword">require</span> (<span class="variable">planet</span> <span class="selfeval">"myenv.ss"</span> (<span class="selfeval">"lizorkin"</span> <span class="selfeval">"ssax.plt"</span> <span class="selfeval">1</span> <span class="selfeval">3</span>))
         (<span class="variable">planet</span> <span class="selfeval">"ssax.ss"</span> (<span class="selfeval">"lizorkin"</span> <span class="selfeval">"ssax.plt"</span> <span class="selfeval">1</span> <span class="selfeval">3</span>))
         (<span class="variable">prefix</span> <span class="variable">list:</span> (<span class="variable">lib</span> <span class="selfeval">"1.ss"</span> <span class="selfeval">"srfi"</span>)))
(<span class="keyword">define</span> <span class="variable">sample-doc</span> <span class="selfeval">"&lt;flights lastUpdate='2004-08-02T17:09:34-07:00'&gt;
&lt;flight vendor='AA' number='1431' departs='2004-08-22T08:30'
boardpoint='DEN' offpoint='DCA'/&gt;
&lt;flight vendor='UA' number='156' departs='2004-08-22T010:20'
boardpoint='DEN' offpoint='DCA'/&gt;
&lt;flight vendor='F9' number='34' departs='2004-08-22T12:35'
boardpoint='DEN' offpoint='DCA'/&gt;
&lt;flight vendor='AA' number='1034' departs='2004-08-22T14:45'
boardpoint='DEN' offpoint='DCA'/&gt;
&lt;flight vendor='UA' number='210' departs='2004-08-22T17:00'
boardpoint='DEN' offpoint='DCA'/&gt;
&lt;/flights&gt;"</span>)
(<span class="keyword">define</span> <span class="variable">flight-list</span> (<span class="variable">ssax:xml-&gt;sxml</span> (<span class="variable">open-input-string</span> <span class="variable">sample-doc</span>) <span class="keyword">'</span>()))
</pre>
</div>
<p />
Now, you can use the following definitions
<p />
<div class="scheme">
  <pre><span class="comment">;; Anamorphic if: if the test succeeds, bind the value
</span><span class="comment">;; to var and make it available to the true expression body.
</span>(<span class="keyword">define-syntax</span> <span class="variable">aif</span>
  (<span class="keyword">syntax-rules</span> ()
    ((<span class="variable">_</span> <span class="variable">var</span> <span class="variable">test-expr</span> <span class="variable">true-expr</span> <span class="variable">false-expr</span>)
     (<span class="keyword">cond</span>
       [<span class="variable">test-expr</span> <span class="keyword">=&gt;</span> (<span class="keyword">lambda</span> (<span class="variable">var</span>) <span class="variable">true-expr</span>)]
       [<span class="keyword">else</span>
        <span class="variable">false-expr</span>]))))
(<span class="keyword">define</span> <span class="variable">children</span> <span class="builtin">cdr</span>)
(<span class="keyword">define</span> (<span class="variable">first-child</span> <span class="variable">n</span>) (<span class="builtin">cadr</span> <span class="variable">n</span>))
(<span class="keyword">define</span> (<span class="variable">node-name</span> <span class="variable">n</span>) (<span class="builtin">car</span> <span class="variable">n</span>))
(<span class="keyword">define</span> (<span class="variable">attributes</span> <span class="variable">n</span>)
  (<span class="keyword">if</span> (<span class="keyword">and</span> (<span class="builtin">pair?</span> <span class="variable">n</span>)
           (<span class="builtin">eq?</span> (<span class="variable">node-name</span> (<span class="variable">first-child</span> <span class="variable">n</span>)) <span class="keyword">'</span><span class="variable">@</span>))
      (<span class="builtin">cdr</span> (<span class="variable">first-child</span> <span class="variable">n</span>))
      <span class="selfeval">#f</span>))
<span class="comment">; find an attribute with the name attr-symb in n's attribute list
</span>(<span class="keyword">define</span> (<span class="variable">find-attribute</span> <span class="variable">n</span> <span class="variable">attr-symb</span>)
  (<span class="keyword">let</span> ((<span class="variable">attrs</span> (<span class="variable">attributes</span> <span class="variable">n</span>)))
    (<span class="keyword">if</span> <span class="variable">n</span>
        (<span class="variable">list:find</span> (<span class="keyword">lambda</span> (<span class="variable">n</span>) (<span class="keyword">and</span> (<span class="builtin">pair?</span> <span class="variable">n</span>) (<span class="builtin">eq?</span> <span class="variable">attr-symb</span> (<span class="builtin">car</span> <span class="variable">n</span>)))) <span class="variable">attrs</span>)
        <span class="selfeval">#f</span>)))
<span class="comment">; return the element children of n
</span>(<span class="keyword">define</span> (<span class="variable">element-axis</span> <span class="variable">n</span>)
  (<span class="keyword">if</span> (<span class="keyword">and</span> (<span class="builtin">pair?</span> <span class="variable">n</span>)
           (<span class="builtin">eq?</span> (<span class="variable">node-name</span> (<span class="variable">first-child</span> <span class="variable">n</span>)) <span class="keyword">'</span><span class="variable">@</span>))
      (<span class="builtin">cddr</span> <span class="variable">n</span>)
      (<span class="builtin">cdr</span> <span class="variable">n</span>)))
<span class="comment">; appends a child to the end of the list of child elements of n.
</span>(<span class="keyword">define</span> (<span class="variable">append-child</span> <span class="variable">n</span> <span class="variable">newChild</span>)
  (<span class="variable">append!</span> (<span class="variable">element-axis</span> <span class="variable">n</span>) (<span class="builtin">list</span> <span class="variable">newChild</span>)))
<span class="comment">; adds an attribute in list form ('attrName "attrValue") to node n
</span>(<span class="keyword">define</span> (<span class="variable">add-attribute</span> <span class="variable">n</span> <span class="variable">attr</span>)
  (<span class="variable">aif</span> <span class="variable">attr-list</span> (<span class="variable">attributes</span> <span class="variable">n</span>)
       (<span class="variable">append!</span> <span class="variable">attr-list</span> <span class="variable">attr</span>)
       ((<span class="builtin">set-cdr!</span> <span class="variable">n</span> (<span class="builtin">cons</span> (<span class="builtin">list</span> <span class="keyword">'</span><span class="variable">@</span> <span class="variable">attr</span>) (<span class="builtin">cdr</span> <span class="variable">n</span>))))))
<span class="comment">; sets the attribute with name eq? attrSymb to attrValue
</span>(<span class="keyword">define</span> (<span class="variable">set-attribute</span> <span class="variable">n</span> <span class="variable">attrSymb</span> <span class="variable">attrValue</span>)
  (<span class="variable">aif</span> <span class="variable">attrib</span> (<span class="variable">find-attribute</span> <span class="variable">n</span> <span class="variable">attrSymb</span>)
       (<span class="builtin">set-car!</span> (<span class="builtin">cdr</span> <span class="variable">attrib</span>) <span class="variable">attrValue</span>)
       <span class="selfeval">#f</span>))
<span class="comment">; finds the (immediate) equal? child in n
</span>(<span class="keyword">define</span> (<span class="variable">find-child</span> <span class="variable">n</span> <span class="variable">child</span>)
  (<span class="variable">list:find</span> (<span class="keyword">lambda</span> (<span class="variable">n</span>) (<span class="builtin">equal?</span> <span class="variable">n</span> <span class="variable">child</span>)) (<span class="variable">children</span> <span class="variable">n</span>)))
<span class="comment">; replaces the equal? child of n with new-child
</span>(<span class="keyword">define</span> (<span class="variable">replace-child</span> <span class="variable">n</span> <span class="variable">child</span> <span class="variable">new-child</span>)
  (<span class="builtin">set-cdr!</span> <span class="variable">n</span> (<span class="builtin">map</span>
               (<span class="keyword">lambda</span> (<span class="variable">node</span>)
                 (<span class="keyword">if</span> (<span class="builtin">equal?</span> <span class="variable">node</span> <span class="variable">child</span>)
                     <span class="variable">new-child</span>
                     <span class="variable">node</span>))
               (<span class="variable">children</span> <span class="variable">n</span>))))
<span class="comment">; works like the InnerText property on the MSXML DOM, all text
</span><span class="comment">; children (not traversing the attribute axis)
</span>(<span class="keyword">define</span> (<span class="variable">inner-text</span> <span class="variable">n</span>)
    (<span class="variable">fold</span> (<span class="keyword">lambda</span> (<span class="variable">n</span> <span class="variable">a</span>)
          (<span class="keyword">cond</span> ((<span class="builtin">string?</span> <span class="variable">n</span>)
                 (<span class="builtin">string-append</span> <span class="variable">a</span> <span class="variable">n</span>))
                ((<span class="keyword">and</span> (<span class="builtin">pair?</span> <span class="variable">n</span>)
                      (<span class="builtin">not</span> (<span class="builtin">eq?</span> <span class="keyword">'</span><span class="variable">@</span> (<span class="builtin">car</span> <span class="variable">n</span>))))
                     (<span class="builtin">string-append</span> <span class="variable">a</span> (<span class="variable">inner-text</span> <span class="variable">n</span>)))
                (<span class="keyword">else</span> <span class="variable">a</span>)))
          <span class="selfeval">""</span>
          <span class="variable">n</span>))
</pre>
</div>
<p />
<p />
-- Note:
<p />
Maybe I'm just confused, but I think "sxpath" makes a lot of the above a lot simpler.
<p />
<p />
-- <a href="/Main/HectorEGomezMorales">HectorEGomezMorales</a> - 05 May 2004
<p />
-- <a href="/Main/GordonWeakliem">GordonWeakliem</a> - 03 Aug 2004
<p />
-- <a href="/Main/DannyYoo">DannyYoo</a> - 08 Oct 2007
Adjusted the example to use <a href="/Cookbook/PLaneT">PLaneT</a>'s version of the <b>SSAX</b> library.  Also included a definition for <code>AIF</code>.
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/XmlRecipes">XmlRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 040 </td>
</tr>
</table>
<p />
 </div>
</div>
