<div id="contentbox">
 <div class="widget">
  <p />
<h2><a name="Creating_simple_AIFF_audio_files"> </a> Creating simple AIFF audio files </h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<a href="/Cookbook/DrScheme">DrScheme</a> seems to have little support for sound.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
Presented here, sample code for writing 16 bit monophonic AIFF audio files, and a few procedures for sound synthesis in order to test it. AIFF files are lossless Interchange File Format-derived audio files used by Apple and SGI, and should hopefully be playable on any modern computer. The reader is advised to consult the internet for the intimate details of AIFF specifically, and the general concepts of IFF. In short, they are a binary format containing nested "chunks" of data. Each "chunk" consists of a 4 character ID tag, followed by 4 bytes representing the chunk size, then the chunk's contents.
<p />
A minimal AIFF file contains one top-level chunk, with the ID of "FORM". This contains inside it a 4 byte type of "AIFF" followed by two chunks, "COMM" and "SSND". COMM, the Common chunk, holds information on the bit size, sample frame rate, and so forth. SSND contains a bitstream representing the audio.
<p />
Upon running this recipe, it will generate 20 seconds of complex audio and write it to a file called "test.aiff", which will be monaural, 16 bit, and at 22kHz sample rate.
<p />
<code>
  <b>enchunk</b>
</code> is a general-purpose function for encoding IFF chunks.
<p />
<code>
  <b>buffer-&gt;aiff</b>
</code> converts a bytestring of sample frames into a bytestring representing an entire AIFF file.
<p />
<code>
  <b>sample-to-bytes</b>
</code> converts a continuous value between -1 and 1 into a 16 bit sample.
<p />
<code>
  <b>op-&gt;buffer</b>
</code> converts a function  of time representing a waveform ("operator") into a buffer (bytestring) representing a waveform.
<p />
Other procedures and constants are essentially just defined for amusement value!
<p />
<div class="scheme">
  <pre><span class="variable">%begin</span> <span class="variable">scheme%</span>
<span class="comment">;;uses swindle and PLT Scheme
</span>
<span class="comment">;;some constants - rates in Hz and as aiff bytestrings
</span>(<span class="keyword">define</span> <span class="variable">rate44kHz</span> (<span class="builtin">cons</span> <span class="selfeval">44100</span> (<span class="variable">bytes</span> <span class="selfeval">#xAC</span> <span class="selfeval">#x44</span> <span class="selfeval">#x00</span> <span class="selfeval">#x00</span>)))
(<span class="keyword">define</span> <span class="variable">rate22kHz</span> (<span class="builtin">cons</span> <span class="selfeval">22255</span> (<span class="variable">bytes</span> <span class="selfeval">#x56</span> <span class="selfeval">#xEE</span> <span class="selfeval">#x8B</span> <span class="selfeval">#xA3</span>)))
(<span class="keyword">define</span> <span class="variable">A440</span> <span class="selfeval">440</span>) <span class="comment">;ISO
</span>(<span class="keyword">define</span> <span class="variable">A480</span> <span class="selfeval">480</span>) <span class="comment">;Bach organ
</span>
<span class="comment">;;useful
</span>(<span class="keyword">define</span> (<span class="variable">linear-pitch-space</span> <span class="variable">p</span> <span class="variable">&amp;opt</span> (<span class="variable">middleA</span> <span class="variable">A440</span>))
  (<span class="keyword">define</span> (<span class="variable">log2</span> <span class="variable">n</span>) (<span class="builtin">/</span> (<span class="builtin">log</span> <span class="variable">n</span>) (<span class="builtin">log</span> <span class="selfeval">2</span>)))
  (<span class="builtin">expt</span> <span class="selfeval">2</span>
        (<span class="builtin">+</span> (<span class="builtin">/</span> (<span class="builtin">-</span> <span class="variable">p</span> <span class="selfeval">69</span>)
              <span class="selfeval">12</span>)
           (<span class="variable">log2</span> <span class="variable">middleA</span>))))
<span class="comment">;;-1&lt;x&lt;1 to 16 bit int
</span>(<span class="keyword">define</span> (<span class="variable">sample-to-bytes</span> <span class="variable">x</span>)
  (<span class="variable">integer-&gt;integer-bytes</span> (<span class="builtin">inexact-&gt;exact</span> (<span class="builtin">floor</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="selfeval">32000</span>))) <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>))
<span class="comment">;;pack data into an IFF chunk
</span>(<span class="keyword">define</span> (<span class="variable">enchunk</span> <span class="variable">ID</span> <span class="variable">buffer</span> <span class="variable">&amp;opt</span> (<span class="variable">prefix</span> (<span class="variable">bytes</span>)))
  (<span class="keyword">let*</span> ((<span class="variable">l</span> (<span class="builtin">+</span> (<span class="variable">bytes-length</span> <span class="variable">buffer</span>)
               (<span class="variable">bytes-length</span> <span class="variable">prefix</span>)))
         (<span class="variable">nobytes</span> (<span class="variable">bytes</span>))
         (<span class="variable">padded</span> (<span class="keyword">if</span> (<span class="builtin">odd?</span> <span class="variable">l</span>)
                     (<span class="builtin">+</span> <span class="selfeval">1</span> <span class="variable">l</span>)
                     <span class="variable">l</span>)))
    (<span class="keyword">if</span> (<span class="builtin">eq?</span> (<span class="builtin">string-length</span> <span class="variable">ID</span>) <span class="selfeval">4</span>)
        (<span class="variable">bytes-append</span> (<span class="variable">string-&gt;bytes/locale</span> <span class="variable">ID</span>)
                      (<span class="variable">integer-&gt;integer-bytes</span> <span class="variable">padded</span> <span class="selfeval">4</span> <span class="selfeval">#f</span> <span class="selfeval">#t</span>)
                      (<span class="keyword">if</span> <span class="variable">prefix</span> <span class="variable">prefix</span> <span class="variable">nobytes</span>)
                      <span class="variable">buffer</span>
                      (<span class="keyword">if</span> (<span class="builtin">odd?</span> <span class="variable">l</span>) (<span class="variable">bytes</span> <span class="selfeval">0</span>) <span class="variable">nobytes</span>))
        (<span class="variable">error</span> <span class="selfeval">"ID must be 4 characters long!"</span>))))
<span class="comment">;;make a buffer of sample frames based on an operator of length t
</span>(<span class="keyword">define</span> (<span class="variable">op-&gt;buffer</span> <span class="variable">operator</span> <span class="variable">t</span> <span class="variable">&amp;opt</span> (<span class="variable">rate</span> <span class="variable">rate44kHz</span>))
  (<span class="keyword">let</span> ((<span class="variable">buffer</span> (<span class="variable">make-bytes</span> (<span class="builtin">*</span> <span class="selfeval">2</span>
                               (<span class="builtin">+</span> <span class="selfeval">1</span> (<span class="builtin">*</span> <span class="variable">t</span> (<span class="builtin">car</span> <span class="variable">rate</span>))))))
        (<span class="variable">end</span> <span class="variable">t</span>)
        (<span class="variable">inc</span> (<span class="builtin">/</span> <span class="selfeval">1</span> (<span class="builtin">car</span> <span class="variable">rate</span>))))
    (<span class="keyword">let</span> <span class="variable">loop</span> ((<span class="variable">x</span> <span class="selfeval">0</span>)
               (<span class="variable">byteoffset</span> <span class="selfeval">0</span>))
      (<span class="keyword">if</span> (<span class="builtin">&gt;</span> <span class="variable">x</span> <span class="variable">end</span>)
          <span class="variable">buffer</span>
          (<span class="keyword">begin</span> (<span class="variable">bytes-copy!</span> <span class="variable">buffer</span>
                              <span class="variable">byteoffset</span>
                              (<span class="variable">sample-to-bytes</span> (<span class="variable">operator</span> <span class="variable">x</span>)))
                 (<span class="variable">loop</span> (<span class="builtin">+</span> <span class="variable">x</span> <span class="variable">inc</span>) (<span class="builtin">+</span> <span class="variable">byteoffset</span> <span class="selfeval">2</span>)))))))
<span class="comment">;;buffer to aiff bytestring
</span>(<span class="keyword">define</span> (<span class="variable">buffer-&gt;aiff</span> <span class="variable">bitstream</span> <span class="variable">&amp;opt</span> (<span class="variable">rate</span> <span class="variable">rate44kHz</span>))
  (<span class="keyword">let</span> ((<span class="variable">frames</span> (<span class="builtin">/</span> (<span class="variable">bytes-length</span> <span class="variable">bitstream</span>) <span class="selfeval">2</span>)))
    <span class="comment">;;FORM chunk contains other chunks
</span>    (<span class="variable">enchunk</span> <span class="selfeval">"FORM"</span>
             (<span class="variable">bytes-append</span>
              <span class="comment">;COMMon block
</span>              (<span class="variable">enchunk</span> <span class="selfeval">"COMM"</span>
                       (<span class="variable">bytes-append</span>
                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>) <span class="comment">;channels (mono)
</span>                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="variable">frames</span> <span class="selfeval">4</span> <span class="selfeval">#f</span> <span class="selfeval">#t</span>) <span class="comment">;sample frames (16)
</span>                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="selfeval">16</span> <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>) <span class="comment">;bitwidth
</span>                        (<span class="variable">bytes</span> <span class="selfeval">#x40</span> <span class="selfeval">#x0E</span>) <span class="comment">;no idea
</span>                        (<span class="builtin">cdr</span> <span class="variable">rate</span>) <span class="comment">;framerate
</span>                        (<span class="variable">bytes</span> <span class="selfeval">0</span> <span class="selfeval">0</span> <span class="selfeval">0</span> <span class="selfeval">0</span>))) <span class="comment">;yet more WTFery.
</span>              <span class="comment">;Sound data block
</span>              (<span class="variable">enchunk</span> <span class="selfeval">"SSND"</span>
                       <span class="variable">bitstream</span>
                       (<span class="variable">make-bytes</span> <span class="selfeval">8</span> <span class="selfeval">0</span>))) <span class="comment">;;quick hack to ignore some unused settings
</span>             <span class="comment">;;Name FORM type
</span>             (<span class="variable">string-&gt;bytes/locale</span> <span class="selfeval">"AIFF"</span>))))
<span class="comment">;;
</span><span class="comment">;;Some operators
</span><span class="comment">;;
</span>
<span class="comment">;;Sinewaves
</span>(<span class="keyword">define</span> (<span class="variable">sinewave</span> <span class="variable">freq</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="builtin">sin</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="variable">freq</span> <span class="selfeval">6.2832</span>))))
<span class="comment">;;whitenoise
</span>(<span class="keyword">define</span> (<span class="variable">noise</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="variable">random</span>)))
<span class="comment">;;VCA
</span>(<span class="keyword">define</span> (<span class="variable">ampmod</span> <span class="variable">signal</span> <span class="variable">mod</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="builtin">*</span> (<span class="variable">signal</span> <span class="variable">x</span>)
                 (<span class="variable">mod</span> <span class="variable">x</span>))))
<span class="comment">;;half-wave
</span>(<span class="keyword">define</span> (<span class="variable">half-wave</span> <span class="variable">op</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="keyword">let</span> ((<span class="variable">b</span> (<span class="variable">op</span> <span class="variable">x</span>)))
      (<span class="keyword">if</span> (<span class="builtin">&gt;</span> <span class="variable">b</span> <span class="selfeval">0</span>) <span class="variable">b</span> <span class="selfeval">0</span>))))
<span class="comment">;;FM
</span>(<span class="keyword">define</span> (<span class="variable">FMoperator</span> <span class="variable">freq</span> <span class="variable">modulation</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="builtin">sin</span> (<span class="builtin">+</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="variable">freq</span> <span class="selfeval">6.2832</span>)
            (<span class="variable">modulation</span> <span class="variable">x</span>)))))
<span class="comment">;;Mix sound sources
</span>(<span class="keyword">define</span> (<span class="variable">mix</span> <span class="variable">&amp;rest</span> <span class="variable">sources</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="builtin">/</span> (<span class="variable">foldl</span> (<span class="keyword">lambda</span> (<span class="variable">operation</span> <span class="variable">sum</span>)
                (<span class="builtin">+</span> <span class="variable">sum</span>
                   (<span class="variable">operation</span> <span class="variable">x</span>)))
              <span class="selfeval">0</span>
              <span class="variable">sources</span>)
       (<span class="builtin">length</span> <span class="variable">sources</span>))))
<span class="comment">;;Amplitude tweak. Will clip cleanly if overdriven.
</span>(<span class="keyword">define</span> (<span class="variable">amp</span> <span class="variable">a</span> <span class="variable">op</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="keyword">let</span> ((<span class="variable">b</span> (<span class="builtin">*</span> <span class="variable">a</span> (<span class="variable">op</span> <span class="variable">x</span>))))
      (<span class="keyword">cond</span> ((<span class="builtin">&lt;</span> <span class="variable">b</span> <span class="selfeval">-1</span>) <span class="selfeval">-1</span>)
            ((<span class="builtin">&gt;</span> <span class="variable">b</span> <span class="selfeval">1</span>) <span class="selfeval">1</span>)
            (<span class="keyword">else</span> <span class="variable">b</span>)))))
<span class="comment">;;
</span><span class="comment">;;generate sound
</span><span class="comment">;;
</span>(<span class="keyword">define</span> <span class="variable">complex-sound</span> (<span class="variable">op-&gt;buffer</span> (<span class="variable">mix</span> (<span class="variable">ampmod</span> (<span class="variable">mix</span> (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">60</span>))
                                                    (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">64</span>))
                                                    (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">67</span>))) <span class="comment">;C major
</span>                                               (<span class="variable">half-wave</span> (<span class="variable">amp</span> <span class="selfeval">10</span> (<span class="variable">FMoperator</span> <span class="selfeval">8</span>
                                                                              (<span class="variable">sinewave</span> <span class="selfeval">1</span>))))) <span class="comment">;morse effect
</span>                                       (<span class="variable">amp</span> <span class="selfeval">0.3</span> (<span class="variable">ampmod</span> (<span class="variable">noise</span>)
                                                        (<span class="variable">sinewave</span> <span class="selfeval">0.08</span>))) <span class="comment">;fading white noise
</span>                                       (<span class="variable">ampmod</span>  (<span class="variable">amp</span> <span class="selfeval">10</span> (<span class="variable">FMoperator</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">58</span>)
                                                                    (<span class="variable">sinewave</span> (<span class="builtin">/</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">58</span>) <span class="selfeval">3</span>)))) <span class="comment">;distorted FM bass
</span>                                                (<span class="variable">sinewave</span> <span class="selfeval">0.01</span>))) <span class="comment">;fade in
</span>                                  <span class="selfeval">20</span>
                                  <span class="variable">rate22kHz</span>))
(<span class="builtin">with-output-to-file</span> <span class="selfeval">"test.aiff"</span>
  (<span class="variable">thunk</span> (<span class="builtin">display</span> (<span class="variable">buffer-&gt;aiff</span> <span class="variable">complex-sound</span> <span class="variable">rate22kHz</span>)))
  <span class="keyword">'</span><span class="variable">replace</span>)
</pre>
</div>
<p />
%end%
<p />
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
Converting this to write WAV files should be trivial. There seems to be a few omissions in the version of the AIFF spec I was using, hence a few (clearly marked) kludges have been used to get it working. Two sample rate constants have been defined, one for 22kHz and one for 44kHz. Currently, bit depth is hard-wired and only one audio channel is supported (ie. mono). When using <code>
  <b>linear-pitch-space</b>
</code>, a value of 60 represents middle C, 61 represents C sharp, 59 represents B and so forth.
<p />
Extensive use is made of extensions provided by Swindle.
<p />
AIFF writing is dog-slow, and it doesn't sound like a Moog.
<p />
To start experimenting more simply, replace the complex sound mix with <code>
  <b>(sinewave A440)</b>
</code> or <code>
  <b>(noise)</b>
</code> for middle A and white noise respectively.
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/RitchieSmith">RitchieSmith</a> - 15 Aug 2006
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/FileRecipes">FileRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
