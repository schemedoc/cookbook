<div id="contentbox">
 <div class="widget">
 <h2>
  <a name="File_Upload"> File Upload </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
You already know how to write complex, and useful <a href="/Cookbook/CGI">CGI</a>s in scheme,
however you need to upload a file (any kind of file) from the user
computer, and into your server.  Unfortunately the <code>cgi.ss</code> library
does not provide any procedures to do that.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
Here we will construct a (partial) but useful implementation of
<a href="http://www.ietf.org/rfc/rfc2388.txt" target="_top">RFC 2388</a>, Returning Values from
Forms: multipart/form-data , that will extend the current
functionality of the <code>cgi.ss</code> library to allow you to upload files.
<p />
This extension involves MIME to analyze responses from clients via the
HTTP protocol.  Fortunately, PLT Scheme has its own <code>mime.ss</code> library,
so this poses no problems at all.
<p />
Just to be clear, once the user fills out the form, and clicks the
<em>Submit</em> button, the browser packs the information and sends it to the
server.  How does a browser packs that information?  The same way as
any other MIME aware app would do with multipart/mixed document: it
writes every name/value pair in a separate part (MIME part if you
prefer), opens a connection to the Web server, and delivers the
<em>standard</em> HTTP headers followed by the MIME message.
<p />
So, the trick in our code is to realize that if we add the header:
<code>Content-type: multipart/form-data</code> to the stream delivered by the
browser we will have, indeed, a well-formed MIME message, one that can
be handled by the <code>mime-analyze</code> procedure from the <code>mime.ss</code> library.
<p />
<div class="scheme">
  <pre>(<span class="keyword">let</span> ((<span class="variable">in</span> (<span class="builtin">current-input-port</span>)))
  (<span class="keyword">let-values</span> ([(<span class="variable">new-in</span> <span class="variable">raw</span>) (<span class="variable">make-pipe</span>)])
    (<span class="variable">fprintf</span> <span class="variable">raw</span> <span class="selfeval">"Content-type: ~a~n~n"</span> (<span class="variable">getenv</span> <span class="selfeval">"CONTENT_TYPE"</span>))
    (<span class="keyword">let</span> <span class="variable">loop</span> ((<span class="variable">ln</span> (<span class="variable">read-line</span> <span class="variable">in</span>)))
      (<span class="keyword">unless</span> (<span class="builtin">eof-object?</span> <span class="variable">ln</span>)
        (<span class="variable">fprintf</span> <span class="variable">raw</span> <span class="selfeval">"~a~n"</span> <span class="variable">ln</span>)
        (<span class="variable">loop</span> (<span class="variable">read-line</span> <span class="variable">in</span>))))
    (<span class="keyword">let*</span> ((<span class="variable">msg</span> (<span class="variable">mime-analyze</span> <span class="variable">new-in</span>))
           (<span class="variable">ent</span> (<span class="variable">message-entity</span> <span class="variable">msg</span>)))
      (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="builtin">eq?</span> (<span class="variable">entity-type</span> <span class="variable">ent</span>) <span class="keyword">'</span><span class="variable">multipart</span>)
                 (<span class="builtin">eq?</span> (<span class="variable">entity-subtype</span> <span class="variable">ent</span>) <span class="keyword">'</span><span class="variable">form-data</span>))
        (<span class="builtin">map</span> <span class="variable">process-part</span> (<span class="variable">entity-parts</span> <span class="variable">ent</span>))))))
</pre>
</div>
<p />
Note that we don't actually insert <code>multipart/form-data</code>, and that's
because we need to know what the <em>boundary</em>, used to separate different
parts, is.  This <em>boundary</em> is a parameter specified also in the
<code>CONTENT_TYPE</code> environment variable.
<p />
It would be nice if this was (as I promise it would be) an extension
of the <code>cgi.ss</code> library, wouldn't it?  To do so, the <code>process-part</code>
procedure, in the last line above, has to return a list of name/value
pairs, <em>ala</em> <code>get-bindings/post</code> , only this time values can be either
strings, or lists of the form <code>(filename type subtype procedure)</code>.  We
could then wrap the whole thing in a <code>get-bindings/mime</code> costume, and
off you go:
<p />
<div class="scheme">
  <pre>(<span class="keyword">define</span> <span class="variable">get-bindings/mime</span>
    (<span class="keyword">lambda</span> ()
      (<span class="keyword">letrec</span> ((<span class="variable">process-part</span>
                (<span class="keyword">lambda</span> (<span class="variable">part</span>)
                  (<span class="keyword">let*</span> ((<span class="variable">ent</span> (<span class="variable">message-entity</span> <span class="variable">part</span>))
                         (<span class="variable">disp</span> (<span class="variable">entity-disposition</span> <span class="variable">ent</span>))
                         (<span class="variable">p</span> (<span class="builtin">cons</span> <span class="keyword">'</span><span class="variable">dummy</span> <span class="keyword">'</span><span class="variable">pair</span>)))
                    (<span class="keyword">case</span> (<span class="variable">disposition-type</span> <span class="variable">disp</span>)
                      ((<span class="variable">form-data</span>) <span class="comment">;; Most typical case first
</span>                       (<span class="builtin">set-car!</span> <span class="variable">p</span> (<span class="variable">form-data-name</span> (<span class="variable">disposition-params</span> <span class="variable">disp</span>)))
                       (<span class="keyword">case</span> (<span class="variable">entity-type</span> <span class="variable">ent</span>)
                         ((<span class="variable">text</span>)
                          (<span class="keyword">let</span> ((<span class="variable">out</span> (<span class="variable">open-output-string</span>)))
                            (<span class="builtin">set-cdr!</span> <span class="variable">p</span> (<span class="keyword">begin</span> ((<span class="variable">entity-body</span> <span class="variable">ent</span>) <span class="variable">out</span>) (<span class="variable">get-output-string</span> <span class="variable">out</span>)))))
                         ((<span class="variable">image</span> <span class="variable">audio</span> <span class="variable">video</span> <span class="variable">application</span>)
                          (<span class="builtin">set-cdr!</span> <span class="variable">p</span> (<span class="builtin">list</span> (<span class="variable">filename-sans-directory</span>
                                             (<span class="variable">disposition-filename</span> <span class="variable">disp</span>))
                                            (<span class="variable">entity-type</span> <span class="variable">ent</span>) (<span class="variable">entity-subtype</span> <span class="variable">ent</span>)
                                            (<span class="variable">entity-body</span> <span class="variable">ent</span>)))) <span class="comment">;; procedure
</span>                         ((<span class="variable">multipart</span> <span class="variable">message</span>)
                          (<span class="builtin">set-cdr!</span> <span class="variable">p</span> (<span class="builtin">list</span>
                                       (<span class="builtin">map</span> <span class="variable">process-part</span> (<span class="variable">entity-parts</span> <span class="variable">ent</span>))))))
                       <span class="comment">;; return pair
</span>                       <span class="variable">p</span>)
                      ((<span class="variable">attachment</span>)
                       (<span class="builtin">list</span> (<span class="variable">filename-sans-directory</span> (<span class="variable">disposition-filename</span> <span class="variable">disp</span>))
                             (<span class="variable">entity-type</span> <span class="variable">ent</span>)
                             (<span class="variable">entity-subtype</span> <span class="variable">ent</span>)
                             (<span class="variable">entity-body</span> <span class="variable">ent</span>)))
                      (<span class="keyword">else</span>
                       (<span class="variable">generate-error-output</span>
                        (<span class="builtin">list</span> <span class="selfeval">"Client generated malformed MIME encapsulation for form data:"</span>
                              (<span class="variable">format</span>
                               <span class="selfeval">"Invalid Content-disposition type: `~a'."</span>
                               (<span class="variable">disposition-type</span> <span class="variable">disp</span>))))))))))
        (<span class="keyword">let</span> ((<span class="variable">in</span> (<span class="builtin">current-input-port</span>)))
          (<span class="keyword">let-values</span> ([(<span class="variable">new-in</span> <span class="variable">raw</span>) (<span class="variable">make-pipe</span>)])
            (<span class="variable">fprintf</span> <span class="variable">raw</span> <span class="selfeval">"Content-type: ~a~n~n"</span> (<span class="variable">getenv</span> <span class="selfeval">"CONTENT_TYPE"</span>))
            (<span class="keyword">let</span> <span class="variable">loop</span> ((<span class="variable">ln</span> (<span class="variable">read-line</span> <span class="variable">in</span>)))
              (<span class="keyword">unless</span> (<span class="builtin">eof-object?</span> <span class="variable">ln</span>)
                (<span class="variable">fprintf</span> <span class="variable">raw</span> <span class="selfeval">"~a~n"</span> <span class="variable">ln</span>)
                (<span class="variable">loop</span> (<span class="variable">read-line</span> <span class="variable">in</span>))))
            (<span class="keyword">let*</span> ((<span class="variable">msg</span> (<span class="variable">mime-analyze</span> <span class="variable">new-in</span>))
                   (<span class="variable">ent</span> (<span class="variable">message-entity</span> <span class="variable">msg</span>)))
              (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="builtin">eq?</span> (<span class="variable">entity-type</span> <span class="variable">ent</span>) <span class="keyword">'</span><span class="variable">multipart</span>)
                         (<span class="builtin">eq?</span> (<span class="variable">entity-subtype</span> <span class="variable">ent</span>) <span class="keyword">'</span><span class="variable">form-data</span>))
                (<span class="builtin">map</span> <span class="variable">process-part</span> (<span class="variable">entity-parts</span> <span class="variable">ent</span>)))))))))
</pre>
</div>
<p />
Alright, that does not look as friendly as it sounds.  But fear not
because this is a very, and I mean <em>very</em> standard MIME message (see,
for instance, a raw version of a common e-mail message you
received... sure: one of those with pictures, and stuff).  In our
case, browsers send MIME messages that can have two kinds of parts:
<code>form-data</code>, or <code>attachment</code>.  Attachments are, plain and simple,
files of one of these types: image, audio, video, application, or
file.  <code>form-data</code>, OTOH, can be text, attachments (files), or other
multipart messages!.  (As you can surely guess, a usual name/value
pair, such as "Name"/"Foo Bar" is added as a MIME part <code>form-data</code>
with type <code>text</code>.)
<p />
<p />
The code above uses a couple of auxiliary procedures, and other
libraries that we won't discuss here.  You can get them all, neatly
wrapped in a PLT module, at the
<a href="http://cvs.sourceforge.net/viewcvs.py/schematics/src/libs/net/" target="_top">Schematics</a>
site.
<p />
<p />
<strong>NOTE:</strong>  that link no longer works, and I'm not sure what planet packages the "auxiliary procedures" are in, or if they are even still available
<p />
-- <a href="/Main/HiSeeComments">HiSeeComments</a> - 01 Jul 2008 (added the note)
<p />
<p />
Let's use the beast, shall we?  In the following example, you are
trying to register a new user to your site, but you require her name,
e-mail address, and picture:
<p />
<pre>
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html&gt;
 &lt;head&gt;&lt;title&gt;Registration&lt;/title&gt;&lt;/head&gt;
 &lt;body&gt;
  &lt;h1&gt;Registration&lt;/h1&gt;
  &lt;p&gt;To register as a new user, simply fill out this form:&lt;/p&gt;
  &lt;form action="/cgi-bin/doregister-with-picture.ss" method="post" enctype="multipart/form-data"&gt;
   &lt;table border="0"&gt;
    &lt;tr&gt;&lt;td align="right"&gt; First &amp; last name: &lt;/td&gt;
        &lt;td&gt;&lt;input type="text" name="Name" size="40" value=""/&gt;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align="right"&gt; Email address: &lt;/td&gt;
        &lt;td&gt;&lt;input type="text" name="Email" size="40" value="" /&gt;&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td align="right"&gt; Picture: &lt;/td&gt;
        &lt;td&gt;&lt;input type="file" name="Picture" /&gt; &lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td colspan="2" align="center"&gt; &lt;input type="submit" value=" Submit " /&gt;&lt;/td&gt;&lt;/tr&gt;
   &lt;/table&gt;
  &lt;/form&gt;
 &lt;/body&gt;
&lt;/html&gt;
</pre>
<p />
<strong>Important:</strong> note the <code>enctype="multipart/form-data"</code>, it is crucial!.
<p />
And finally, our scheme script to eat the form information including,
of course, the picture provided by the user:
<p />
<div class="scheme">
  <pre><span class="selfeval">#!/bin/sh</span>
<span class="selfeval">":"</span><span class="comment">;exec /home/solsona/scheme/plt/bin/mzscheme -r $0
</span>
(<span class="keyword">require</span> (<span class="variable">lib</span> <span class="selfeval">"cgi.ss"</span> <span class="selfeval">"net"</span>)
         (<span class="variable">lib</span> <span class="selfeval">"file-upload.ss"</span> <span class="selfeval">"net"</span>))
(<span class="keyword">let*</span> ((<span class="variable">b</span> (<span class="variable">get-bindings/mime</span>))
       (<span class="variable">name</span> (<span class="variable">extract-binding/single</span> <span class="selfeval">"Name"</span> <span class="variable">b</span>))
       (<span class="variable">email</span> (<span class="variable">extract-binding/single</span> <span class="selfeval">"Email"</span> <span class="variable">b</span>))
       (<span class="variable">picture</span> (<span class="variable">extract-binding/single</span> <span class="selfeval">"Picture"</span> <span class="variable">b</span>)))
  <span class="comment">;; Process information, and do the actual registration...
</span>  <span class="comment">;; ... and finally, we return to the user (HTML of course)
</span>  (<span class="keyword">let</span> ((<span class="variable">image</span> (<span class="builtin">car</span> <span class="variable">picture</span>))
        (<span class="variable">writeme</span> (<span class="builtin">cadddr</span> <span class="variable">picture</span>)))
    (<span class="builtin">call-with-output-file</span> (<span class="variable">build-path</span> <span class="selfeval">"/usr/local/www/data/images/"</span> <span class="variable">image</span>) <span class="variable">writeme</span>)
    (<span class="variable">generate-html-output</span>
     <span class="selfeval">"Thank you!"</span>
     (<span class="builtin">list</span> (<span class="variable">format</span> <span class="selfeval">"Dear ~a, "</span> <span class="variable">name</span>)
           <span class="selfeval">"We have received your information, and this completes the registration process."</span>
           <span class="selfeval">"Thank you!."</span>
           <span class="selfeval">"&lt;br /&gt;"</span>
           (<span class="variable">format</span> <span class="selfeval">"&lt;img src=\"/images/~a\" border=\"1\"&gt;"</span> <span class="variable">image</span>))))
  )
</pre>
</div>
<p />
-- <a href="/Main/FranciscoSolsona">FranciscoSolsona</a> - 07 Apr 2004
<p />
<p />
<a href="/Cookbook/ToDo">ToDo</a>: Fix the broken link, or remove the use of "auxiliary procedures" if they are no longer available (i believe those procedures might be making this unusable)
<p />
-- <a href="/Main/HiSeeComments">HiSeeComments</a> - 01 Jul 2008
<p />
The following change got me closer to working:
<div class="scheme">
  <pre>(<span class="keyword">case</span> (<span class="variable">disposition-type</span> <span class="variable">disp</span>)
  ((<span class="variable">form-data</span>) <span class="comment">;; Most typical case first
</span>   (<span class="builtin">set-car!</span> <span class="variable">p</span> (<span class="builtin">string-&gt;symbol</span> (<span class="builtin">cdr</span> (<span class="builtin">assoc</span> <span class="selfeval">"name"</span>
<span class="comment">;(form-data-name
</span>                                      (<span class="variable">disposition-params</span> <span class="variable">disp</span>)) )))
</pre>
</div>
<p />
-- <a href="/Main/HiSeeComments">HiSeeComments</a> - 01 Jul 2008
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/WebRecipes">WebRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 040 </td>
</tr>
</table>
<p />
 </div>
</div>
