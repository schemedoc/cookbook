<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Scripting_Example_Untar"> Scripting Example: Untar </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
You want to use Scheme to do something that you would normally do using a shell script.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
PLT Scheme has a great deal of support for scripting-style functionality.  To demonstrate some of these features, the following program was converted from <a href="http://maplefish.com/todd/misc/untar" target="_top">this bash script</a>.  See the header comment for an explanation of this script.
<p />
<div class="scheme">
  <pre><span class="selfeval">#!/usr/bin/scheme-sh</span>
<span class="comment">; Unpack a tarfile and make sure that it ends up in a single directory
</span><span class="comment">; with a name derived from the tarball (create this if necessary).
</span><span class="comment">; Example: "untar foo-1.0.tar.gz" will always put the files in foo-1.0/
</span><span class="comment">; Written by Luke Gorrie &lt;luke at synap dot  se&gt; in February 2006.
</span><span class="comment">;
</span><span class="comment">; Obfuscated by Todd Coram &lt;todd at maplefish dot com&gt; on February 7, 2006.
</span><span class="comment">;    Todd also added support for plain old .tar!
</span><span class="comment">;
</span><span class="comment">; "Transliterated" ;) from bash to Scheme
</span><span class="comment">; by Anton van Straaten &lt;anton at appsolutions.com&gt; on February 9, 2006.
</span>
(<span class="keyword">define</span> (<span class="variable">main</span> <span class="variable">args</span>)
  (<span class="variable">match</span> <span class="variable">args</span>
    ((<span class="builtin">list</span> <span class="variable">_</span> <span class="variable">file</span>)
     (<span class="variable">match-let*</span> ((<span class="variable">basefile</span> (<span class="variable">file-name-from-path</span> <span class="variable">file</span>))
                  <span class="comment">; we will make sure everything goes into the 'wantdir' directory
</span>                  ((<span class="builtin">list</span> <span class="variable">wantdir</span> <span class="variable">ext</span>) (<span class="variable">split-filename</span> <span class="variable">basefile</span>)))
       <span class="comment">; argument validation
</span>       (<span class="keyword">or</span> (<span class="variable">file-exists?</span> <span class="variable">file</span>) (<span class="variable">die</span> <span class="selfeval">"abort: file does not exist"</span>))
       (<span class="keyword">if</span> (<span class="variable">-d</span> <span class="variable">wantdir</span>) (<span class="variable">die</span> <span class="selfeval">"abort: ~a already exists"</span> <span class="variable">wantdir</span>))
       <span class="comment">; detect compression scheme
</span>       (<span class="keyword">let</span> ((<span class="variable">compression</span>
              (<span class="keyword">case</span> (<span class="builtin">string-&gt;symbol</span> <span class="variable">ext</span>)
                ((<span class="variable">tar</span>)        <span class="selfeval">""</span>)
                ((<span class="variable">tar.gz</span> <span class="variable">tgz</span>) <span class="selfeval">"z"</span>)
                ((<span class="variable">tar.bz2</span>)    <span class="selfeval">"j"</span>)
                (<span class="keyword">else</span> (<span class="variable">die</span> <span class="selfeval">"Unrecognized file format"</span>))))
             (<span class="variable">tmpdir</span> (<span class="keyword">or</span> (<span class="variable">make-temporary-dir</span> <span class="selfeval">"untar.~a"</span>)
                         (<span class="variable">die</span> <span class="selfeval">"Can't mkdir ~a"</span> <span class="variable">tmpdir</span>))))
         <span class="comment">;
</span>         <span class="comment">; Extract &amp; move &amp; cleanup
</span>         <span class="comment">;
</span>         (<span class="variable">try-pk</span> (<span class="variable">exn:break?</span>
                  (<span class="keyword">if</span> (<span class="variable">-d</span> <span class="variable">tmpdir</span>)
                      (<span class="variable">run</span> (<span class="variable">rm</span> <span class="variable">-rf</span> <span class="keyword">,</span><span class="variable">tmpdir</span>))))
           (|| (<span class="variable">tar</span> <span class="keyword">,</span>(<span class="variable">$</span> <span class="keyword">'</span><span class="variable">Cxf</span> <span class="variable">compression</span>) <span class="keyword">,</span><span class="variable">tmpdir</span> <span class="keyword">,</span><span class="variable">file</span>)
               ((<span class="variable">rm</span> <span class="variable">-rf</span> <span class="keyword">,</span><span class="variable">tmpdir</span>) (<span class="variable">exit</span> <span class="selfeval">1</span>)))
           (<span class="keyword">cond</span>
             ((<span class="builtin">equal?</span> (<span class="variable">run</span> (<span class="variable">ls</span> <span class="selfeval">-1</span> <span class="keyword">,</span><span class="variable">tmpdir</span>)) (<span class="builtin">list</span> <span class="variable">wantdir</span>))
              <span class="comment">; The archive unpacked the way we want
</span>              (<span class="variable">&amp;&amp;</span> (<span class="variable">mv</span> <span class="keyword">,</span>(<span class="variable">$</span> <span class="variable">tmpdir</span> <span class="keyword">'</span><span class="builtin">/</span> <span class="variable">wantdir</span>) <span class="selfeval">"."</span>) (<span class="variable">rmdir</span> <span class="keyword">,</span><span class="variable">tmpdir</span>)))
             (<span class="keyword">else</span>
               <span class="comment">; "Messy" unpack. Put it under the desired directory.
</span>               (<span class="variable">printf</span> <span class="selfeval">"untar: creating ~a\n"</span> <span class="variable">wantdir</span>)
               (<span class="variable">run</span> (<span class="variable">mv</span> <span class="keyword">,</span><span class="variable">tmpdir</span> <span class="keyword">,</span><span class="variable">wantdir</span>))))))))
    (<span class="keyword">else</span> (<span class="variable">die</span> <span class="selfeval">"Usage: untar filename(.tar|.tar.gz|.tgz|.tar.bz2)"</span>))))
</pre>
</div>
<p />
The above program relies on some general routines which provide additional support for a few basic scripting-style operations, some of which have been very loosely modeled on features found in scsh.  For the above script to run correctly, <code>/usr/bin/scheme-sh</code> should be a link to the <code>mzscheme</code> binary, and the following program should be saved as <code>init.ss</code> in a directory called <code>plt/collects/script-lang/sh</code>.  (This triggers <a href="/Cookbook/MzScheme">MzScheme</a>'s built-in script engine support.)
<p />
<div class="scheme">
  <pre>(<span class="keyword">module</span> <span class="variable">init</span> <span class="variable">mzscheme</span>
  (<span class="keyword">require</span> (<span class="variable">lib</span> <span class="selfeval">"file.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"process.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"plt-match.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"list.ss"</span> <span class="selfeval">"srfi"</span> <span class="selfeval">"1"</span>))
  (<span class="keyword">provide</span> (<span class="variable">all-from</span> (<span class="variable">lib</span> <span class="selfeval">"file.ss"</span>))
           (<span class="variable">all-from</span> (<span class="variable">lib</span> <span class="selfeval">"process.ss"</span>))
           (<span class="variable">all-from</span> (<span class="variable">lib</span> <span class="selfeval">"plt-match.ss"</span>))
           (<span class="variable">all-from</span> (<span class="variable">lib</span> <span class="selfeval">"list.ss"</span> <span class="selfeval">"srfi"</span> <span class="selfeval">"1"</span>))
           <span class="variable">run</span> <span class="variable">&amp;&amp;</span> || <span class="variable">$</span> <span class="variable">-d</span> <span class="variable">die</span>
           <span class="variable">make-temporary-dir</span> <span class="variable">split-filename</span>
           <span class="variable">intersperse</span>
           <span class="variable">try-pk</span>)
  <span class="comment">; run one or more shell commands, specified as s-exps.
</span>  <span class="comment">; Returns the output of the last command as a list of lines.
</span>  (<span class="keyword">define-syntax</span> <span class="variable">run</span>
    (<span class="keyword">syntax-rules</span> ()
      ((<span class="variable">_</span> <span class="variable">cmd</span> ...)
       (<span class="keyword">begin</span> (<span class="variable">exec-cmd</span> <span class="keyword">`</span><span class="variable">cmd</span> <span class="selfeval">#t</span>) ...))))
  <span class="comment">; run a sequence of shell commands, specified as s-exps,
</span>  <span class="comment">; returning if any of the commands returns a non-zero error code.
</span>  (<span class="keyword">define-syntax</span> <span class="variable">&amp;&amp;</span>
    (<span class="keyword">syntax-rules</span> ()
      ((<span class="variable">_</span> <span class="variable">cmd</span> ...)
       (<span class="keyword">and</span> (<span class="builtin">zero?</span> (<span class="variable">exec-cmd</span> <span class="keyword">`</span><span class="variable">cmd</span> <span class="selfeval">#f</span>)) ...))))
  <span class="comment">; run a sequence of shell commands, specified as s-exps,
</span>  <span class="comment">; stopping once a command returns a success code (zero)
</span>  (<span class="keyword">define-syntax</span> ||
    (<span class="keyword">syntax-rules</span> ()
      ((<span class="variable">_</span> <span class="variable">cmd</span> ...)
       (<span class="keyword">or</span> (<span class="builtin">zero?</span> (<span class="variable">exec-cmd</span> <span class="keyword">`</span><span class="variable">cmd</span> <span class="selfeval">#f</span>)) ...))))
  <span class="comment">; appends a list of arbitrary arguments into a string
</span>  (<span class="keyword">define</span> (<span class="variable">$</span> . <span class="variable">args</span>)
    (<span class="builtin">apply</span> <span class="builtin">string-append</span>
     (<span class="builtin">map</span>
      (<span class="keyword">lambda</span> (<span class="variable">s</span>)
        (<span class="keyword">cond</span>
          ((<span class="builtin">symbol?</span>  <span class="variable">s</span>) (<span class="builtin">symbol-&gt;string</span> <span class="variable">s</span>))
          ((<span class="builtin">string?</span>  <span class="variable">s</span>) <span class="variable">s</span>)
          ((<span class="builtin">number?</span>  <span class="variable">s</span>) (<span class="builtin">number-&gt;string</span> <span class="variable">s</span>))
          ((<span class="builtin">boolean?</span> <span class="variable">s</span>) (<span class="keyword">if</span> <span class="variable">s</span> <span class="selfeval">"true"</span> <span class="selfeval">"false"</span>))
          ((<span class="variable">path?</span>    <span class="variable">s</span>) (<span class="variable">path-&gt;string</span> <span class="variable">s</span>))
          (<span class="keyword">else</span> <span class="selfeval">"ERROR!"</span>)))
      <span class="variable">args</span>)))
  (<span class="keyword">define</span> (<span class="variable">exec-cmd</span> <span class="variable">cmd</span> <span class="variable">capture-output?</span>)
    (<span class="keyword">if</span> (<span class="keyword">and</span> (<span class="builtin">pair?</span> <span class="variable">cmd</span>)
             (<span class="builtin">pair?</span> (<span class="builtin">car</span> <span class="variable">cmd</span>)))
        (<span class="builtin">for-each</span> <span class="variable">exec-cmd</span> <span class="variable">cmd</span>)
        (<span class="keyword">let</span> ((<span class="variable">cmd-str</span> (<span class="variable">process-cmd</span> <span class="variable">cmd</span>)))
          <span class="comment">;(debug-out cmd-str)
</span>          (<span class="keyword">if</span> <span class="variable">capture-output?</span>
              (<span class="variable">system/output</span> <span class="variable">cmd-str</span>)
              (<span class="variable">system/exit-code</span> <span class="variable">cmd-str</span>)))))
  (<span class="keyword">define</span> (<span class="variable">intersperse</span> <span class="variable">l</span> <span class="variable">delim</span>)
    (<span class="builtin">reverse</span> (<span class="variable">reverse-intersperse</span> <span class="variable">l</span> <span class="variable">delim</span>)))
  <span class="comment">; intersperses delim into list l, and returns in reverse order
</span>  (<span class="keyword">define</span> (<span class="variable">reverse-intersperse</span> <span class="variable">l</span> <span class="variable">delim</span>)
    (<span class="keyword">if</span> (<span class="builtin">null?</span> <span class="variable">l</span>) <span class="variable">l</span>
        (<span class="variable">fold</span>
         (<span class="keyword">lambda</span> (<span class="variable">x</span> <span class="variable">l</span>)
           (<span class="builtin">cons</span> <span class="variable">x</span> (<span class="builtin">cons</span> <span class="selfeval">" "</span> <span class="variable">l</span>)))
         (<span class="builtin">list</span> (<span class="builtin">car</span> <span class="variable">l</span>))
         (<span class="builtin">cdr</span> <span class="variable">l</span>))))
  <span class="comment">; bit of a cheat: using make-temporary-file to make a temporary dir
</span>  (<span class="keyword">define</span> (<span class="variable">make-temporary-dir</span> <span class="variable">template</span>)
    (<span class="variable">try-pk</span> (<span class="variable">exn:fail:filesystem?</span> <span class="selfeval">#f</span>)
      (<span class="keyword">let</span> ((<span class="variable">path</span> (<span class="variable">make-temporary-file</span> <span class="variable">template</span>)))
        (<span class="variable">delete-file</span> <span class="variable">path</span>)
        (<span class="variable">make-directory</span> <span class="variable">path</span>)
        <span class="variable">path</span>)))
  <span class="comment">; keep those crazy bashers from complaining about verbosity
</span>  (<span class="keyword">define</span> <span class="variable">-d</span> <span class="variable">directory-exists?</span>)
  (<span class="keyword">define</span> <span class="variable">split-filename</span>
    (<span class="keyword">let</span> ((<span class="variable">rx</span> <span class="selfeval">#rx</span><span class="selfeval">"(.+?)\\.(.*)"</span>))
      (<span class="keyword">lambda</span> (<span class="variable">filename</span>)
        (<span class="keyword">let*</span> ((<span class="variable">filename</span> (<span class="keyword">if</span> (<span class="variable">path?</span> <span class="variable">filename</span>) (<span class="variable">path-&gt;string</span> <span class="variable">filename</span>) <span class="variable">filename</span>))
               (<span class="variable">pieces</span> (<span class="variable">regexp-match</span> <span class="variable">rx</span> <span class="variable">filename</span>)))
          (<span class="keyword">and</span> <span class="variable">pieces</span> (<span class="builtin">cdr</span> <span class="variable">pieces</span>))))))
  (<span class="keyword">define</span> (<span class="variable">quote-string</span> <span class="variable">s</span>)
    (<span class="builtin">string-append</span> <span class="selfeval">"\""</span> <span class="variable">s</span> <span class="selfeval">"\""</span>))
  (<span class="keyword">define</span> (<span class="variable">process-cmd</span> <span class="variable">cmd</span>)
    (<span class="variable">fold</span> <span class="builtin">string-append</span> <span class="selfeval">""</span>
     (<span class="variable">reverse-intersperse</span>
      (<span class="builtin">map</span>
       (<span class="keyword">lambda</span> (<span class="variable">s</span>)
         (<span class="keyword">cond</span>
           ((<span class="builtin">symbol?</span>  <span class="variable">s</span>) (<span class="builtin">symbol-&gt;string</span> <span class="variable">s</span>))
           ((<span class="builtin">string?</span>  <span class="variable">s</span>) (<span class="variable">quote-string</span> <span class="variable">s</span>))
           ((<span class="builtin">number?</span>  <span class="variable">s</span>) (<span class="builtin">number-&gt;string</span> <span class="variable">s</span>))
           ((<span class="builtin">boolean?</span> <span class="variable">s</span>) (<span class="keyword">if</span> <span class="variable">s</span> <span class="selfeval">"true"</span> <span class="selfeval">"false"</span>))
           ((<span class="variable">path?</span>    <span class="variable">s</span>) (<span class="variable">path-&gt;string</span> <span class="variable">s</span>))
           (<span class="keyword">else</span> <span class="selfeval">"ERROR!"</span>)))
       <span class="variable">cmd</span>)
      <span class="selfeval">" "</span>)))
  (<span class="keyword">define</span> (<span class="variable">die</span> <span class="variable">s</span> . <span class="variable">vals</span>)
    (<span class="builtin">apply</span> <span class="variable">fprintf</span> (<span class="variable">current-error-port</span>) <span class="variable">s</span> <span class="variable">vals</span>) (<span class="builtin">newline</span>)
    (<span class="variable">exit</span> <span class="selfeval">1</span>))
  <span class="comment">; "try" with a single predicate and a "naked" handler (not a closure)
</span>  (<span class="keyword">define-syntax</span> <span class="variable">try-pk</span>
    (<span class="keyword">syntax-rules</span> ()
      ((<span class="variable">_</span> (<span class="variable">pred</span> <span class="variable">handler</span> ...) <span class="variable">body</span> ...)
       (<span class="keyword">with-handlers</span> ((<span class="variable">pred</span> (<span class="keyword">lambda</span> (<span class="variable">exn</span>) <span class="variable">handler</span> ...)))
         <span class="variable">body</span> ...))))
  <span class="comment">; from http://schemecookbook.org/Cookbook/FileReadingLines
</span>  (<span class="keyword">define</span> (<span class="variable">fold-lines</span> <span class="variable">proc</span> <span class="variable">init</span> . <span class="variable">port+mode</span>)
    (<span class="keyword">let</span> <span class="variable">while</span> ((<span class="variable">accum</span> <span class="variable">init</span>))
      (<span class="keyword">let</span> ((<span class="variable">line</span> (<span class="builtin">apply</span> <span class="variable">read-line</span> <span class="variable">port+mode</span>)))
        (<span class="keyword">if</span> (<span class="builtin">eof-object?</span> <span class="variable">line</span>) <span class="variable">accum</span>
            (<span class="variable">while</span> (<span class="variable">proc</span> <span class="variable">line</span> <span class="variable">accum</span>))))))
  (<span class="keyword">define</span> (<span class="variable">read-all-lines</span> <span class="variable">port</span>)
    (<span class="builtin">reverse</span> (<span class="variable">fold-lines</span> <span class="builtin">cons</span> <span class="keyword">'</span>() <span class="variable">port</span>)))
  <span class="comment">;; from http://schemecookbook.org/Cookbook/ProcessCaptureOutput
</span>
  <span class="comment">;; system/output : string -&gt; (U string #f)
</span>  <span class="comment">;;
</span>  <span class="comment">;; Synchronously run the given command through the shell and
</span>  <span class="comment">;; capture standard output.
</span>  <span class="comment">;;
</span>  <span class="comment">;; Returns the standard output or #f if the command failed
</span>  <span class="comment">;;
</span>  <span class="comment">;; If the command blocks for any reason (e.g. waiting for
</span>  <span class="comment">;; input) this function will as well.
</span>  (<span class="keyword">define</span> (<span class="variable">system/output</span> <span class="variable">command-string</span>)
    (<span class="keyword">let-values</span> (((<span class="variable">out</span> <span class="variable">in</span> <span class="variable">id</span> <span class="variable">err</span> <span class="variable">ctrl</span>)
                  (<span class="builtin">apply</span> <span class="builtin">values</span> (<span class="variable">process</span> <span class="variable">command-string</span>))))
      (<span class="variable">ctrl</span> <span class="keyword">'</span><span class="variable">wait</span>)  <span class="comment">;; wait for the process to finish
</span>      (<span class="keyword">begin0</span>
        (<span class="keyword">case</span> (<span class="variable">ctrl</span> <span class="keyword">'</span><span class="variable">status</span>)
          ((<span class="variable">done-ok</span>)
           (<span class="variable">read-all-lines</span> <span class="variable">out</span>))
          (<span class="keyword">else</span> <span class="selfeval">#f</span>))
        (<span class="builtin">close-output-port</span> <span class="variable">in</span>)
        (<span class="variable">close-input-port</span> <span class="variable">out</span>)
        (<span class="variable">close-input-port</span> <span class="variable">err</span>)))))
</pre>
</div>
<p />
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
TODO.
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
Needs more explanation.
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/AntonVanStraaten">AntonVanStraaten</a> - 10 Feb 2006
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/ProcessRecipes">ProcessRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
