<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Applying_a_md5_checksum_through_"> Applying a md5 checksum through multiple updates </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
We may want to apply an md5 checksum on a bunch of strings in a file, such as the textual content of an xml document.  We may not have content as a single string, but as many short substrings.
<p />
The <strong>md5</strong> library from mzlib only appears to support input from a single byte string or a port, and makes it seem that using it on mulitple strings requires concatenation or an scratch file to treat as a port.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
The following code puts a small wrapper to allow md5 to eat multiple bites of bytes.
<p />
<div class="scheme">
  <pre>(<span class="keyword">module</span> <span class="variable">updatable-md5</span> <span class="variable">mzscheme</span>
  <span class="comment">;; updatable md5: a wrapper around (lib "md5.ss") to allow multiple input sources.
</span>
  <span class="comment">;; The standard library interface from mzlib's md5 module requires a single
</span>  <span class="comment">;; input port.  This library puts a wrapper around (lib "md5.ss") to take in
</span>  <span class="comment">;; multiple input ports.  When we're satisifed, we can then call digest to get
</span>  <span class="comment">;; the digest of the total input.
</span>
  <span class="comment">;; I really wanted this so I could more accurately run the tree-folding examples
</span>  <span class="comment">;; from Oleg Kiselyov's "A Better XML Parser through Functional Programming".
</span>  <span class="comment">;; (http://okmij.org/ftp/Scheme/xml.html)
</span>
  (<span class="keyword">require</span> (<span class="variable">lib</span> <span class="selfeval">"port.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"md5.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"contract.ss"</span>))
  <span class="comment">;; An md5-state encapsulates what we need to talk to the md5 library.  We
</span>  <span class="comment">;; treat this as an opaque structure to the outside world.
</span>  (<span class="keyword">define-struct</span> <span class="variable">md5-state</span> (<span class="variable">op</span> <span class="variable">ch</span> <span class="variable">result</span>))
  <span class="comment">;; make-md5: -&gt; md5-state
</span>  <span class="comment">;; Makes a fresh md5-state.
</span>  (<span class="keyword">provide</span> <span class="variable">make-md5</span>)
  (<span class="keyword">define</span> (<span class="variable">make-md5</span>)
    (<span class="variable">define-values</span> (<span class="variable">ip</span> <span class="variable">op</span>) (<span class="variable">make-pipe</span> <span class="variable">ip</span> <span class="variable">op</span>))
    (<span class="keyword">define</span> <span class="variable">ch</span> (<span class="variable">make-channel</span>))
    (<span class="keyword">define</span> <span class="variable">state</span> (<span class="variable">make-md5-state</span> <span class="variable">op</span> <span class="variable">ch</span> <span class="selfeval">#f</span>))
    (<span class="variable">thread</span> (<span class="keyword">lambda</span> () (<span class="variable">channel-put</span> <span class="variable">ch</span> (<span class="variable">md5</span> <span class="variable">ip</span>))))
    <span class="variable">state</span>)
  <span class="comment">;; update/port: md5-state input-port -&gt; void
</span>  <span class="comment">;; Feed in more data from an input port to be digested into our md5 state.
</span>  (<span class="variable">provide/contract</span> (<span class="variable">update/port</span> (<span class="variable">md5-state?</span> <span class="builtin">input-port?</span> . <span class="variable">-&gt;</span> . <span class="variable">any</span>)))
  (<span class="keyword">define</span> (<span class="variable">update/port</span> <span class="variable">state</span> <span class="variable">ip</span>)
    (<span class="variable">check-not-digested!</span> <span class="keyword">'</span><span class="variable">update/port</span> <span class="variable">state</span>)
    (<span class="variable">copy-port</span> <span class="variable">ip</span> (<span class="variable">md5-state-op</span> <span class="variable">state</span>))
    (<span class="variable">void</span>))
  <span class="comment">;; update/bytes: md5-state bytes -&gt; void
</span>  <span class="comment">;; Feed in more data from bytes to be digested into our md5 state.
</span>  (<span class="variable">provide/contract</span> (<span class="variable">update/bytes</span> (<span class="variable">md5-state?</span> <span class="variable">bytes?</span> . <span class="variable">-&gt;</span> . <span class="variable">any</span>)))
  (<span class="keyword">define</span> (<span class="variable">update/bytes</span> <span class="variable">state</span> <span class="variable">bytes</span>)
    (<span class="variable">check-not-digested!</span> <span class="keyword">'</span><span class="variable">update/bytes</span> <span class="variable">state</span>)
    (<span class="variable">write-bytes</span> <span class="variable">bytes</span> (<span class="variable">md5-state-op</span> <span class="variable">state</span>))
    (<span class="variable">void</span>))
  (<span class="keyword">define</span> (<span class="variable">digested?</span> <span class="variable">state</span>)
    (<span class="keyword">and</span> (<span class="variable">md5-state-result</span> <span class="variable">state</span>) <span class="selfeval">#t</span>))
  <span class="comment">;; check-not-digested!: symbol md5-state -&gt; void
</span>  <span class="comment">;; raise error if digest has been called on state.
</span>  (<span class="keyword">define</span> (<span class="variable">check-not-digested!</span> <span class="variable">who</span> <span class="variable">state</span>)
    (<span class="keyword">when</span> (<span class="variable">digested?</span> <span class="variable">state</span>)
      (<span class="variable">error</span> <span class="variable">who</span> <span class="selfeval">"Already digested; no further updates allowed."</span>)))
  <span class="comment">;; digest: md5-state -&gt; bytes
</span>  (<span class="variable">provide/contract</span> (<span class="variable">digest</span> (<span class="variable">md5-state?</span> . <span class="variable">-&gt;</span> . <span class="variable">bytes?</span>)))
  (<span class="keyword">define</span> (<span class="variable">digest</span> <span class="variable">state</span>)
    (<span class="keyword">when</span> (<span class="builtin">not</span> (<span class="variable">digested?</span> <span class="variable">state</span>))
      (<span class="builtin">close-output-port</span> (<span class="variable">md5-state-op</span> <span class="variable">state</span>))
      (<span class="variable">set-md5-state-result!</span> <span class="variable">state</span> (<span class="variable">channel-get</span> (<span class="variable">md5-state-ch</span> <span class="variable">state</span>))))
    (<span class="variable">md5-state-result</span> <span class="variable">state</span>)))
</pre>
</div>
<p />
<p />
Example usage:
<div class="scheme">
  <pre><span class="builtin">&gt;</span> (<span class="keyword">define</span> <span class="variable">m</span> (<span class="variable">make-md5</span>))
<span class="builtin">&gt;</span> (<span class="variable">update/bytes</span> <span class="variable">m</span> <span class="selfeval">#</span><span class="selfeval">"Nobody inspects"</span>)
<span class="builtin">&gt;</span> (<span class="variable">update/port</span> <span class="variable">m</span> (<span class="variable">open-input-bytes</span> <span class="selfeval">#</span><span class="selfeval">" the "</span>))
<span class="builtin">&gt;</span> (<span class="variable">update/port</span> <span class="variable">m</span> (<span class="variable">open-input-bytes</span> <span class="selfeval">#</span><span class="selfeval">"spammish repetition"</span>))
<span class="builtin">&gt;</span> (<span class="variable">digest</span> <span class="variable">m</span>)
<span class="selfeval">#</span><span class="selfeval">"bb649c83dd1ea5c9d9dec9a18df0ffe9"</span>
</pre>
</div>
<p />
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
This solution is quite clever.
<p />
Recently (today actually) a message digest package supporting incremental generation
was added to <a href="/Cookbook/PLaneT">PLaneT</a>. See <a href="http://planet.plt-scheme.org/300/#digest.plt" target="_top">Digest package at PLaneT</a>.
<p />
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a> - 05 Feb 2007
<p />
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/DannyYoo">DannyYoo</a> - 28 Jun 2006
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/StringChapter">StringChapter</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
