<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Block_based_Sieve_of_Eratosthene"> Block-based "Sieve of Eratosthenes" </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
The "Sieve of Eratosthenes" is simple algorithm for finding primes. It starts with a big table of numbers and "crosses out" all multiples of 2, 3, 5, 7...
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
<div class="scheme">
  <pre><span class="comment">;; return a a byte vector representation of the primes between 3 and
</span><span class="comment">;; `size'
</span>(<span class="keyword">define</span> (<span class="variable">make-base-block</span> <span class="variable">size</span>)
  (<span class="keyword">let</span> ((<span class="variable">block</span> (<span class="variable">make-byte-vector</span> <span class="variable">size</span> <span class="selfeval">1</span>))
        (<span class="variable">limit</span> (<span class="builtin">inexact-&gt;exact</span> (<span class="builtin">truncate</span> (<span class="builtin">/</span> (<span class="builtin">sqrt</span> (<span class="builtin">*</span> <span class="variable">size</span> <span class="selfeval">2</span>)) <span class="selfeval">2</span>)))))
    (<span class="keyword">do</span> ((<span class="variable">i</span> <span class="selfeval">0</span> (<span class="builtin">+</span> <span class="selfeval">1</span> <span class="variable">i</span>)))
        ((<span class="builtin">&gt;=</span> <span class="variable">i</span> <span class="variable">limit</span>) <span class="variable">block</span>)
      (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="variable">byte-vector-ref</span> <span class="variable">block</span> <span class="variable">i</span>) <span class="selfeval">1</span>)
          (<span class="keyword">let</span> ((<span class="variable">prime</span> (<span class="builtin">+</span> (<span class="builtin">*</span> <span class="variable">i</span> <span class="selfeval">2</span>) <span class="selfeval">3</span>)))
            (<span class="keyword">do</span> ((<span class="variable">k</span> (<span class="builtin">+</span> <span class="variable">i</span> <span class="variable">prime</span>) (<span class="builtin">+</span> <span class="variable">k</span> <span class="variable">prime</span>)))
                ((<span class="builtin">&gt;=</span> <span class="variable">k</span> <span class="variable">size</span>) <span class="selfeval">#t</span>)
              (<span class="variable">byte-vector-set!</span> <span class="variable">block</span> <span class="variable">k</span> <span class="selfeval">0</span>)))))))
<span class="comment">;; Given a block of primes in base-block (which must cover the primes
</span><span class="comment">;; up to `(sqrt (+ base (byte-vector-length block)))', set all
</span><span class="comment">;; locations in `block' to 1 that are prime and all others to 0.
</span>(<span class="keyword">define</span> (<span class="variable">sieve-block!</span> <span class="variable">base-block</span> <span class="variable">base</span> <span class="variable">block</span>)
  (<span class="variable">byte-vector-fill!</span> <span class="variable">block</span> <span class="selfeval">1</span>)
  (<span class="keyword">let*</span> ((<span class="variable">size</span> (<span class="variable">byte-vector-length</span> <span class="variable">block</span>))
         (<span class="variable">limit</span> (<span class="builtin">quotient</span> (<span class="builtin">truncate</span> (<span class="builtin">sqrt</span> (<span class="builtin">+</span> <span class="variable">base</span> (<span class="builtin">*</span> <span class="variable">size</span> <span class="selfeval">2</span>)))) <span class="selfeval">2</span>)))
    (<span class="keyword">do</span> ((<span class="variable">i</span> <span class="selfeval">0</span> (<span class="builtin">+</span> <span class="variable">i</span> <span class="selfeval">1</span>)))
        ((<span class="builtin">&gt;=</span> <span class="variable">i</span> <span class="variable">limit</span>) <span class="variable">block</span>)
      (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="variable">byte-vector-ref</span> <span class="variable">base-block</span> <span class="variable">i</span>) <span class="selfeval">1</span>)
          (<span class="keyword">let*</span> ((<span class="variable">prime</span> (<span class="builtin">+</span> (<span class="builtin">*</span> <span class="variable">i</span> <span class="selfeval">2</span>) <span class="selfeval">3</span>))
                 (<span class="variable">multiple</span> (<span class="keyword">let</span> <span class="variable">loop</span> ((<span class="variable">multiple</span> (<span class="builtin">*</span> (<span class="builtin">quotient</span> <span class="variable">base</span> <span class="variable">prime</span>) <span class="variable">prime</span>)))
                             (<span class="keyword">if</span> (<span class="keyword">or</span> (<span class="builtin">&lt;</span> <span class="variable">multiple</span> <span class="variable">base</span>)
                                     (<span class="builtin">=</span> (<span class="builtin">remainder</span> <span class="variable">multiple</span> <span class="selfeval">2</span>) <span class="selfeval">0</span>))
                                 (<span class="variable">loop</span> (<span class="builtin">+</span> <span class="variable">multiple</span> <span class="variable">prime</span>))
                                 <span class="variable">multiple</span>))))
            (<span class="keyword">do</span> ((<span class="variable">k</span> (<span class="builtin">quotient</span> (<span class="builtin">-</span> <span class="variable">multiple</span> <span class="variable">base</span>) <span class="selfeval">2</span>) (<span class="builtin">+</span> <span class="variable">k</span> <span class="variable">prime</span>)))
                ((<span class="builtin">&gt;=</span> <span class="variable">k</span> <span class="variable">size</span>) <span class="selfeval">#t</span>)
              (<span class="variable">byte-vector-set!</span> <span class="variable">block</span> <span class="variable">k</span> <span class="selfeval">0</span>)))))))
</pre>
</div>
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
The number of iterations in procedure make-base-block can be reduced by replacing the line
<p />
            (do ((k (+ i prime) (+ k prime)))
<p />
by
<p />
            (do ((k (/ (- (* prime prime) 3) 2) (+ k prime)))
<p />
Because all multiples of the prime smaller than (* prime prime) have already been erased. <a href="/Main/JosKoot">JosKoot</a> - 24 Nov 2006
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/AndreasRottmann">AndreasRottmann</a> - 08 Jun 2005
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/NumberRecipes">NumberRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
