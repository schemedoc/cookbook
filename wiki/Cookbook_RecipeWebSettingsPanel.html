<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Building_settings_panels_for_the"> Building settings panels for the web </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
<p />
We want to make settings panels without an Apply button so that changes take effect immediately, just as in most GNOME apps.  We want to do this on the web.
<p />
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
First, using a template toolkit, let's describe the UI like this:
<p />
<pre>
&lt;html&gt;
 &lt;head&gt;
  &lt;script type="text/javascript" src="/utils.js"/&gt;
 &lt;/head&gt;
 &lt;body&gt;
  &lt;h1&gt;Settings&lt;/h1&gt;
  &lt;input type="checkbox" id="show-email"
     onclick="javascript:void(httpGetText('&lt;? show-email?-toggle-url ?&gt;'))"/&gt;
   Show email&lt;br/&gt;
 &lt;/body&gt;
&lt;/html&gt;
</pre>
<p />
The <code>&lt;?</code> and <code>?&gt;</code> markers begin and end <code>mzpp</code> escapes, and <code>httpGetText</code> is a wrapper around mozilla's/IE's/Opera's <code>XMLHttpRequest</code> object.  Then we hook it up like this:
<p />
<div class="scheme">
  <pre>  <span class="comment">; start : request -&gt; response
</span>  (<span class="keyword">define</span> (<span class="variable">start</span> <span class="variable">initial-request</span>)
    (<span class="variable">send/suspend/dispatch</span>
      (<span class="keyword">lambda</span> (<span class="variable">embed/url</span>)
        (<span class="variable">translate</span> <span class="selfeval">"settings.shtml"</span>
                   <span class="keyword">`</span>([<span class="variable">show-email?-toggle-url</span>
                        <span class="keyword">,</span>(<span class="variable">embed/url</span>
                           (<span class="keyword">lambda</span> (<span class="variable">req</span>)
                             (<span class="variable">printf</span> <span class="selfeval">"toggle show-email~n"</span>)
                             <span class="keyword">`</span>(<span class="variable">html</span> (<span class="variable">body</span> <span class="selfeval">"toggled"</span>))))])))))
</pre>
</div>
<p />
where the <code>translate</code> function takes a template file and its environment to produce the finished document.
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
We need some support libraries: one in Scheme to handle the templating, and another in <span style="background : #FFFFCE;">
  <font color="#0000FF">JavaScript</font>
</span><a href="/edit/Cookbook/JavaScript?topicparent=Cookbook.RecipeWebSettingsPanel">?</a> to provide <code>httpGetText</code>.
<p />
(Note: I'll move the Scheme code into its own recipe or <a href="/Cookbook/PLaneT">PLaneT</a> in a bit)
<p />
<b>template.ss</b>:
<div class="scheme">
  <pre>(<span class="keyword">module</span> <span class="variable">template</span> <span class="variable">mzscheme</span>
  (<span class="keyword">provide</span> <span class="variable">translate</span> <span class="variable">translate/print</span> <span class="variable">translate/str</span>)
  (<span class="keyword">require</span> (<span class="variable">lib</span> <span class="selfeval">"mzpp.ss"</span> <span class="selfeval">"preprocessor"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"xml.ss"</span> <span class="selfeval">"xml"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"etc.ss"</span>)
           (<span class="variable">lib</span> <span class="selfeval">"string.ss"</span>))
  (<span class="keyword">define</span> (<span class="variable">translate/print</span> <span class="variable">filename</span> <span class="variable">bindings</span>)
    (<span class="variable">parameterize</span> ([<span class="variable">current-namespace</span> (<span class="variable">make-namespace</span> <span class="keyword">'</span><span class="variable">initial</span>)]
                   [<span class="variable">beg-mark</span> <span class="selfeval">"&lt;?"</span>]
                   [<span class="variable">end-mark</span> <span class="selfeval">"?&gt;"</span>])
      (<span class="builtin">for-each</span> (<span class="keyword">lambda</span> (<span class="variable">binding</span>)
                  (<span class="variable">namespace-set-variable-value!</span> (<span class="builtin">car</span> <span class="variable">binding</span>) (<span class="builtin">cadr</span> <span class="variable">binding</span>)))
                <span class="variable">bindings</span>)
      (<span class="variable">preprocess</span> <span class="variable">filename</span>)))
  (<span class="keyword">define</span> (<span class="variable">translate/str</span> <span class="variable">filename</span> <span class="variable">bindings</span>)
    (<span class="keyword">define</span> <span class="variable">os</span> (<span class="variable">open-output-string</span>))
    (<span class="variable">parameterize</span> ([<span class="builtin">current-output-port</span> <span class="variable">os</span>])
      (<span class="variable">translate/print</span> <span class="variable">filename</span> <span class="variable">bindings</span>))
    (<span class="variable">get-output-string</span> <span class="variable">os</span>))
  (<span class="keyword">define</span> (<span class="variable">translate</span> <span class="variable">filename</span> <span class="variable">bindings</span>)
    (<span class="variable">define-values</span> (<span class="variable">in</span> <span class="variable">out</span>) (<span class="variable">make-pipe</span>))
    (<span class="variable">thread</span> (<span class="keyword">lambda</span> ()
              (<span class="variable">parameterize</span> ([<span class="builtin">current-output-port</span> <span class="variable">out</span>])
                (<span class="variable">translate/print</span> <span class="variable">filename</span> <span class="variable">bindings</span>))
              (<span class="builtin">close-output-port</span> <span class="variable">out</span>)))
    (<span class="variable">xml-&gt;xexpr</span> (<span class="variable">document-element</span> (<span class="variable">read-xml</span> <span class="variable">in</span>))))
  )
</pre>
</div>
<p />
<b>utils.js</b>:
<table width="100%" border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td bgcolor="#FFFFFF">
      <pre><b><font color="#A020F0">function</font></b> <b><font color="#0000FF">makeReqObj</font></b>() { <b><font color="#A020F0">return</font></b> <b><font color="#A020F0">new</font></b> XMLHttpRequest(); }
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpSendGeneric</font></b>(method, url, content, errorHandler) {
  <b><font color="#A020F0">try</font></b> {
    netscape.security.PrivilegeManager.enablePrivilege(<b><font color="#BC8F8F">"UniversalBrowserRead"</font></b>);
  } <b><font color="#A020F0">catch</font></b> (e) {
    softError(<b><font color="#BC8F8F">"httpSendGeneric"</font></b>,
               e.toString() + <b><font color="#BC8F8F">" Could not enable UniversalBrowserRead privilege."</font></b>);
  }
  <b><font color="#A020F0">try</font></b> {
    <b><font color="#A020F0">var</font></b> http = makeReqObj();
    <b><font color="#A020F0">if</font></b> (!http) {
      <b><font color="#A020F0">if</font></b> (errorHandler) errorHandler(<b><font color="#BC8F8F">"httpSendGeneric"</font></b>, <b><font color="#BC8F8F">"could not create http object"</font></b>);
      <b><font color="#A020F0">else</font></b> softError(<b><font color="#BC8F8F">"httpSendGeneric"</font></b>, <b><font color="#BC8F8F">"could not create http object"</font></b>);
    }
    http.open(method, url, <b><font color="#A020F0">false</font></b>);
    http.send(content);
    httpCheckOK(http, errorHandler);
    <b><font color="#A020F0">return</font></b> http;
  } <b><font color="#A020F0">catch</font></b> (e) {
    <b><font color="#A020F0">if</font></b> (errorHandler) errorHandler(<b><font color="#BC8F8F">"httpSendGeneric"</font></b>, e.toString());
    <b><font color="#A020F0">else</font></b> softError(<b><font color="#BC8F8F">"httpSendGeneric"</font></b>, e.toString());
      <b><font color="#A020F0">return</font></b> <b><font color="#A020F0">null</font></b>;
  }
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetGeneric</font></b>(url, errorHandler) {
  <b><font color="#A020F0">return</font></b> httpSendGeneric(<b><font color="#BC8F8F">"GET"</font></b>, url, <b><font color="#A020F0">null</font></b>, errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpPostGeneric</font></b>(url, content, errorHandler) {
  <b><font color="#A020F0">return</font></b> httpSendGeneric(<b><font color="#BC8F8F">"POST"</font></b>, url, content, errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetGenericK</font></b>(url, k, errorHandler) {
  <b><font color="#A020F0">var</font></b> http = makeReqObj();
  http.open(<b><font color="#BC8F8F">"GET"</font></b>, url, <b><font color="#A020F0">true</font></b>);
  http.onreadystatechange = <b><font color="#A020F0">function</font></b> () {
    <i><font color="#B22222">// 4 means loaded
</font></i>    <b><font color="#A020F0">if</font></b> (http.readyState == 4) {
      httpCheckOK(http, errorHandler);
      k(http);
    }
  }
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">softError</font></b>(callerName, msg) {
  alert(msg);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpCheckOK</font></b>(http, errorHandler) {
  <b><font color="#A020F0">if</font></b> (http.status == 200) {
    <i><font color="#B22222">//alert("looks ok");
</font></i>    <b><font color="#A020F0">return</font></b>;
  } <b><font color="#A020F0">else</font></b> <b><font color="#A020F0">if</font></b> (errorHandler) {
    errorHandler(http);
  }<b><font color="#A020F0">else</font></b> {
    softError(<b><font color="#BC8F8F">"http"</font></b>, http.statusText);
  }
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetK</font></b>(url, k, errorHandler) {
  httpGetGenericK(url,
                  <b><font color="#A020F0">function</font></b> (http) {k(http.responseXML);},
                  errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetKText</font></b>(url, k, errorHandler) {
  httpGetGenericK(url,
                  <b><font color="#A020F0">function</font></b> (http) {k(http.responseText);},
                  errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">DOMParseText</font></b>(str, contentType, errorHandler) {
  <b><font color="#A020F0">try</font></b> {
    <b><font color="#A020F0">return</font></b> (<b><font color="#A020F0">new</font></b> DOMParser()).parseFromString(str, contentType);
  } <b><font color="#A020F0">catch</font></b> (e) {
    <b><font color="#A020F0">if</font></b> (errorHandler) errorHandler(<b><font color="#BC8F8F">"DOMParseText"</font></b>, e);
    <b><font color="#A020F0">else</font></b> softError(<b><font color="#BC8F8F">"DOMParseText"</font></b>, e);
    <b><font color="#A020F0">return</font></b> <b><font color="#A020F0">null</font></b>;
  }
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetHTML</font></b>(url,errorHandler) {
  <b><font color="#A020F0">return</font></b> DOMParseText(httpGetText(url, errorHandler),
                      <b><font color="#BC8F8F">"text/html"</font></b>, errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetXML</font></b>(url,errorHandler) {
  <b><font color="#A020F0">return</font></b> DOMParseText(httpGetText(url, errorHandler),
                      <b><font color="#BC8F8F">"text/xml"</font></b>, errorHandler);
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpGetText</font></b>(url, errorHandler) {
  <b><font color="#A020F0">return</font></b> httpGetGeneric(url, errorHandler).responseText;
}
<b><font color="#A020F0">function</font></b> <b><font color="#0000FF">httpPost</font></b>(url, content, errorHandler) {
  <b><font color="#A020F0">return</font></b> httpPostGeneric(url, content, errorHandler).responseXML;
}</pre>
    </td>
  </tr>
</table>
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/DanielSilva">DanielSilva</a> - 11 Jan 2005
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/WebRecipes">WebRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
