<div id="contentbox">
 <div class="widget">
 <h2>
  <a name="Sharing_state_between_two_functi"> Sharing state between two functions </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
Defining two functions sharing state without polluting the
top level with unneccesary definitions.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
There are several solutions to this problem.
<p />
1. Using <code>define-values</code>
<p />
<div class="scheme">
  <pre> (<span class="variable">define-values</span> (<span class="variable">inc</span> <span class="variable">dec</span> <span class="variable">reset</span>)
      (<span class="keyword">let</span> ([<span class="variable">state</span> <span class="selfeval">0</span>])
        (<span class="keyword">define</span> (<span class="variable">inc</span>)  (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">+</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
        (<span class="keyword">define</span> (<span class="variable">dec</span>)  (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">-</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
        (<span class="keyword">define</span> (<span class="variable">reset</span>)(<span class="keyword">set!</span> <span class="variable">state</span> <span class="selfeval">0</span>)           <span class="variable">state</span>)
        (<span class="builtin">values</span> <span class="variable">inc</span> <span class="variable">dec</span> <span class="variable">reset</span>)))
</pre>
</div>
<p />
2. Using modules
<p />
<div class="scheme">
  <pre>  (<span class="keyword">module</span> <span class="variable">foo</span> <span class="variable">mzscheme</span>
      (<span class="keyword">provide</span> <span class="variable">inc</span> <span class="variable">dec</span> <span class="variable">reset</span>)
      (<span class="keyword">define</span> <span class="variable">state</span> <span class="selfeval">0</span>)
      (<span class="keyword">define</span> (<span class="variable">inc</span>)  (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">+</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
      (<span class="keyword">define</span> (<span class="variable">dec</span>)  (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">-</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
      (<span class="keyword">define</span> (<span class="variable">reset</span>)(<span class="keyword">set!</span> <span class="variable">state</span> <span class="selfeval">0</span>)           <span class="variable">state</span>))
</pre>
</div>
<p />
3. Using a let to keep the shared state out of the top level
<p />
<div class="scheme">
  <pre>  (<span class="keyword">define</span> <span class="variable">inc</span>   <span class="keyword">'</span><span class="variable">uninitialized</span>)
  (<span class="keyword">define</span> <span class="variable">dec</span>   <span class="keyword">'</span><span class="variable">uninitialized</span>)
  (<span class="keyword">define</span> <span class="variable">reset</span> <span class="keyword">'</span><span class="variable">uninitialized</span>)
  (<span class="keyword">let</span> ([<span class="variable">state</span> <span class="selfeval">0</span>])
    (<span class="keyword">define</span> (<span class="variable">internal-inc</span>)    (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">+</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
    (<span class="keyword">define</span> (<span class="variable">internal-dec</span>)    (<span class="keyword">set!</span> <span class="variable">state</span> (<span class="builtin">-</span> <span class="variable">state</span> <span class="selfeval">1</span>)) <span class="variable">state</span>)
    (<span class="keyword">define</span> (<span class="variable">internal-reset</span>)  (<span class="keyword">set!</span> <span class="variable">state</span> <span class="selfeval">0</span>)           <span class="variable">state</span>)
    (<span class="keyword">set!</span> <span class="variable">inc</span>   <span class="variable">internal-inc</span>)
    (<span class="keyword">set!</span> <span class="variable">dec</span>   <span class="variable">internal-dec</span>)
    (<span class="keyword">set!</span> <span class="variable">reset</span> <span class="variable">internal-reset</span>))
</pre>
</div>
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
The first and third solutions uses nothing more than plain R5RS
(<code>define-values</code> can be defined using syntax-rules).
<p />
The second solution is perhaps the most common, when there is no
compatibility concerns.
<p />
<p />
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a>
<p />
<h3>
  <a name="Comments"> Comments </a>
</h3>
<p />
Sharing state between two functions - aside from R5RS compliance, what are the relative advantages/disadvantages?
How does each solution work?
How will each solution affect usage?
<p />
-- <a href="/Main/GordonWeakliem">GordonWeakliem</a> - 26 Apr 2004
<p />
Solution 1 shows intent most clearly.
Solution 2 is often used if you already are using modules (no extra work)
Solution 3 is the only directly portable.
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a>
<p />
Is there an implementation of <code>define-values</code> available anywhere?
<p />
-- <a href="/Main/AndrewWilcox">AndrewWilcox</a> - 05 Dec 2004
<p />
In some Scheme implementations such as <span style="background : #FFFFCE;">
  <font color="#0000FF">PLT Scheme</font>
</span><a href="/edit/Cookbook/PLTScheme?topicparent=Cookbook.IdiomSharingState">?</a> it is simply
a primitive. In others one can by simple means define your own.
As an example the following was written by Shiro Kawai for <span style="background : #FFFFCE;">
  <font color="#0000FF">Gauche</font>
</span><a href="/edit/Cookbook/Gauche?topicparent=Cookbook.IdiomSharingState">?</a>:
<div class="scheme">
  <pre>(<span class="keyword">define-syntax</span> <span class="variable">define-values</span>
  (<span class="keyword">syntax-rules</span> ()
    ((<span class="variable">_</span> <span class="selfeval">"gentmp"</span> (<span class="variable">tmp</span> ...) () (<span class="variable">var</span> ...) <span class="variable">expr</span>)
     (<span class="keyword">begin</span> (<span class="keyword">define</span> <span class="variable">var</span> (<span class="variable">undefined</span>)) ...
            (<span class="variable">receive</span> (<span class="variable">tmp</span> ...) <span class="variable">expr</span>
              (<span class="keyword">set!</span> <span class="variable">var</span> <span class="variable">tmp</span>) ...
              (<span class="variable">undefined</span>))))
    ((<span class="variable">_</span> <span class="selfeval">"gentmp"</span> (<span class="variable">tmp</span> ...) (<span class="variable">v</span> <span class="variable">v2</span> ...) (<span class="variable">var</span> ...) <span class="variable">expr</span>)
     (<span class="variable">define-values</span> <span class="selfeval">"gentmp"</span> (<span class="variable">tmp</span> ... <span class="variable">tmp1</span>) (<span class="variable">v2</span> ...) (<span class="variable">var</span> ...) <span class="variable">expr</span>))
    ((<span class="variable">_</span> (<span class="variable">var</span>  ...) <span class="variable">expr</span>)
     (<span class="variable">define-values</span> <span class="selfeval">"gentmp"</span> () (<span class="variable">var</span> ...) (<span class="variable">var</span> ...) <span class="variable">expr</span>))
    ((<span class="variable">_</span> . <span class="keyword">else</span>)
     (<span class="variable">syntax-error</span> <span class="selfeval">"malformed define-values"</span> (<span class="variable">define-values</span> . <span class="keyword">else</span>)))
    ))
</pre>
</div>
It uses <code>receive</code> , which is defined in it's own <a href="/Cookbook/SRFI">SRFI</a>. It also uses
<code>(undefined)</code> to produce an undefined value. One can use <code>(if #f 42)</code>
in stead.
<p />
See <a href="http://cvs.sourceforge.net/viewcvs.py/gauche/Gauche/src/gauche-init.scm?rev=1.72" target="_top">gauche-init.scm</a>.
<p />
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a> - 05 Dec 2004
<p />
Thank you.
<p />
I notice that in R5RS internal definitions (R5RS 5.2.2) and in module systems such as in Chez Scheme, a series of definitions may be followed by expressions, but further definitions can't follow an expression.  Since this <code>define-values</code> expands into a <code>receive</code> expression, a <code>define-values</code> defintion can not be followed by more definitions within a body or a module.  I wonder if it is <i>possible</i> to implement a <code>define-values</code> macro in a way so that it can be followed by more definitions.  I've been looking at this, and I'm beginning to suspect not.
<p />
-- <a href="/Main/AndrewWilcox">AndrewWilcox</a> - 05 Dec 2004
<p />
Interesting question. I suspect that is the reason <code>define-values</code> is a primitive in <span style="background : #FFFFCE;">
  <font color="#0000FF">PLT Scheme</font>
</span><a href="/edit/Cookbook/PLTScheme?topicparent=Cookbook.IdiomSharingState">?</a>,
but try asking the same question at <span style="background : #FFFFCE;">
  <font color="#0000FF">comp.lang.scheme</font>
</span><a href="/edit/Cookbook/Complangscheme?topicparent=Cookbook.IdiomSharingState">?</a>.
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a> - 05 Dec 2004
<p />
I just wrote a version of the above <code>define-values</code> syntax-rules macro using Scheme48 explicit renaming macros:
<p />
<div class="scheme">
  <pre><span class="keyword">,</span><span class="variable">open</span> <span class="variable">primitives</span> <span class="comment">; for UNSPECIFIC
</span><span class="keyword">,</span><span class="variable">open</span> <span class="variable">srfi-8</span>     <span class="comment">; for RECEIVE
</span><span class="keyword">,</span><span class="variable">for-syntax</span> <span class="keyword">,</span><span class="variable">open</span> <span class="variable">scheme</span> <span class="variable">srfi-1</span> <span class="variable">destructuring</span>
(<span class="keyword">define-syntax</span> <span class="variable">define-values</span>
  (<span class="keyword">lambda</span> (<span class="variable">form</span> <span class="variable">r</span> <span class="variable">compare</span>)
    (<span class="keyword">define</span> (<span class="variable">gensym</span> <span class="variable">i</span>)
      (<span class="variable">r</span> (<span class="builtin">string-&gt;symbol</span> (<span class="builtin">string-append</span> <span class="selfeval">"x"</span> (<span class="builtin">number-&gt;string</span> <span class="variable">i</span>)))))
    (<span class="variable">destructure</span> (((<span class="variable">define-values</span> <span class="builtin">values</span> <span class="variable">expr</span>) <span class="variable">form</span>))
      (<span class="keyword">let</span> ((<span class="variable">tmp-vars</span> (<span class="builtin">map</span> <span class="variable">gensym</span> (<span class="variable">iota</span> (<span class="builtin">length</span> <span class="builtin">values</span>)))))
        <span class="keyword">`</span>(<span class="keyword">,</span>(<span class="variable">r</span> <span class="keyword">'</span><span class="keyword">begin</span>)
          <span class="keyword">,@</span>(<span class="builtin">map</span> (<span class="keyword">lambda</span> (<span class="variable">name</span>) <span class="keyword">`</span>(<span class="keyword">,</span>(<span class="variable">r</span> <span class="keyword">'</span><span class="keyword">define</span>) <span class="keyword">,</span><span class="variable">name</span> (<span class="keyword">,</span>(<span class="variable">r</span> <span class="keyword">'</span><span class="variable">unspecific</span>)))) <span class="builtin">values</span>)
          (<span class="keyword">,</span>(<span class="variable">r</span> <span class="keyword">'</span><span class="variable">receive</span>) <span class="keyword">,</span><span class="variable">tmp-vars</span> <span class="keyword">,</span><span class="variable">expr</span>
           <span class="keyword">,@</span>(<span class="builtin">map</span> (<span class="keyword">lambda</span> (<span class="variable">var</span> <span class="variable">tmp</span>) <span class="keyword">`</span>(<span class="keyword">,</span>(<span class="variable">r</span> <span class="keyword">'</span><span class="keyword">set!</span>) <span class="keyword">,</span><span class="variable">var</span> <span class="keyword">,</span><span class="variable">tmp</span>)) <span class="builtin">values</span> <span class="variable">tmp-vars</span>)))))))
</pre>
</div>
<p />
<p />
-- <a href="/Main/AndreasRottmann">AndreasRottmann</a> - 23 May 2005
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/IdiomRecipes">IdiomRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left">  </td>
</tr>
</table>
<p />
 </div>
</div>
