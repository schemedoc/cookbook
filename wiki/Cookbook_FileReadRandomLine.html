<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Retrieving_a_Line_at_Random_from"> Retrieving a Line at Random from a File of Unknown Size </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
You have a file of unknown size, and you need to select one line at random from it.  The file may be very large, so you don't want to put it all in memory at once, and want to do this in a single pass.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<div class="scheme">
  <pre><span class="comment">;; random-line : (U string path) -&gt; string
</span><span class="comment">;;
</span><span class="comment">;; Returns a random line from the given file, using only a single pass through the file.
</span><span class="comment">;; Each line has an equal chance of being chosen.
</span>(<span class="keyword">define</span> (<span class="variable">random-line/stdin</span>)
  (<span class="keyword">let</span> <span class="variable">reader</span> ([<span class="variable">chance</span> <span class="selfeval">1</span>] <span class="comment">; chance that a line becomes the new result
</span>               [<span class="variable">result</span> <span class="selfeval">""</span>]) <span class="comment">; current result if there are no more lines
</span>    (<span class="keyword">cond</span> [(<span class="builtin">eof-object?</span> (<span class="builtin">peek-char</span>)) <span class="variable">result</span>] <span class="comment">; end of file, return current result
</span>          [(<span class="builtin">zero?</span> (<span class="variable">random</span> <span class="variable">chance</span>)) <span class="comment">; this line is the new result
</span>           (<span class="variable">reader</span> (<span class="variable">add1</span> <span class="variable">chance</span>) (<span class="variable">read-line</span> (<span class="builtin">current-input-port</span>) <span class="keyword">'</span><span class="variable">any</span>))] <span class="comment">; continue
</span>          [<span class="keyword">else</span> (<span class="variable">read-line</span> (<span class="builtin">current-input-port</span>) <span class="keyword">'</span><span class="variable">any</span>) <span class="comment">; discard a line
</span>           (<span class="variable">reader</span> (<span class="variable">add1</span> <span class="variable">chance</span>) <span class="variable">result</span>)]))) <span class="comment">; continue
</span>
(<span class="keyword">define</span> (<span class="variable">random-line</span> <span class="variable">filename</span>)
  (<span class="builtin">with-input-from-file</span> <span class="variable">filename</span> <span class="variable">random-line/stdin</span>))
</pre>
</div>
<p />
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
How this works: This program stores one line, it's eventual result, at all times.  It continues reading lines until it comes to the end of the file; when it reads line <em>n</em> there is a 1/ <em>n</em> chance that it replaces the result, and an ( <em>n</em> -1)/ <em>n</em> chance that the result remains the same.
<p />
As an example, consider the case that there are 3 lines in the file.  During the first iteration, there is a 1/1 chance that the line read is stored as the new result.  During the second iteration, there is a 1/2 chance that the line read is stored as the new result, and a 1/2 chance that the first line remains.  During the third iteration, there is a 1/3 chance that the third line is stored as the result, and a 2/3 chance that the previous result remains.  2/3 * 1/2 = 1/3, thus there is a cumulative 1/3 chance that the first line will be the result and a cumulative 1/3 chance that the second line will be the result.  On the fourth iteration, the result (which has an equal probability of being any of the three lines read so far) is returned.
<p />
Sampling an element from a stream in a single pass is known as reservoir sampling, the reservoir being <code>result</code> in the implementation above.  This technique can be used to sample from any data structure that can be sequentially iterated.  For example, the same technique could be used to sample an element from a tree using only a single pass through the tree.  It is also possible to sample from a non-uniform distribution, though the details are beyond the scope of this article.
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
If the record size is guaranteed to be constant, this problem has a much simpler solution.  However, I assumed that you meant for this function to get a random line from any text file.  I apologize if the code style isn't Cookbook Convention; this is my first edit.  Feel free to tweak it.
<p />
And of course, the program has been tested.  I had it draw 3000 random liens from a 6 line file, and got each line ~500 times, with no apparent favoritism toward earlier or later lines.
This function WOULD fail if the number of lines in the file is enough to make the random number generator begin giving skewed results, ie: a significant fraction of 2147483647. <br>
-- <a href="/Main/BrianJ">BrianJ</a> - 11 Dec 2006
<p />
Nice recipe <a href="/Main/BrianJ">BrianJ</a>!  I've added a comment for the code.  You might want to move your discussion of the algorithm into the Discussion section above, and the code could use <code>with-input-from-file</code>, making it more robust against errors.  It is also worth noting that reserviour sampling can be used for many other situations.  For example, I've used it draw random sub-trees from a tree.  I was first shown this trick by <a href="/Main/OlegK">OlegK</a>.
<p />
-- <a href="/Main/NoelWelsh">NoelWelsh</a> - 11 Dec 2006
<p />
Thanks for your comments.  I'm a little busy due to exams tomorrow, but I'll try to implement the rest of your suggestions soon.  UPDATE: I used <code>with-input-from-file</code>, as requested.
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/GordonWeakliem">GordonWeakliem</a> - 13 Aug 2004
<p />
-- <a href="/Main/BrianJ">BrianJ</a> - 11 Dec 2006
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/FileRecipes">FileRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
