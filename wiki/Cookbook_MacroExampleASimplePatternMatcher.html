<div id="contentbox">
 <div class="widget">
  <p />
<h2>
  <a name="Macro_Example_A_simple_pattern_m"> Macro Example: A simple pattern matcher </a>
</h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
Write a simple pattern matcher with syntax-rules.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
The following is a very naï¿½ve implementation of
a subset of the pattern matcher used in PLT Scheme.
It is not meant to be used instead of (lib "match.ss"),
but rather to show how syntax-rules can be used in
an example of medium size.
<p />
<p />
<p />
<div class="scheme">
  <pre><span class="comment">;; jas-match.scm
</span>
<span class="comment">;;; NOTE
</span>
<span class="comment">;  Uncomment match-define-values and match-define-values-helper,
</span><span class="comment">;  if your Scheme doesn't support define-values.
</span>
<span class="comment">;;; INSTRUCTIONS OF USE
</span>
<span class="comment">; The user macros are
</span><span class="comment">;    (match expr (pattern &lt;guard&gt; expr) ...)    , &lt;guard&gt; can be omitted
</span><span class="comment">;    (match-lambda (pattern expr ...) ...)
</span><span class="comment">;    (match-let ((pattern expr) ...) expr ...)
</span><span class="comment">;    (match-let* ((pattern expr) ...) expr ...)
</span>
<span class="comment">; The syntax of patterns are a subset of the one in:
</span><span class="comment">;     &lt;http://download.plt-scheme.org/scheme/plt-clean-cvs/collects/mzlib/plt-match.ss&gt;
</span>
<span class="comment">; The semantics of the match functions are explained in
</span><span class="comment">;     &lt;http://download.plt-scheme.org/scheme/docs/html/mzlib/mzlib-Z-H-22.html#node_chap_22&gt;
</span>
<span class="comment">; Notably features missing:
</span><span class="comment">;   - quasi-patterns
</span><span class="comment">;   - set! and get!
</span><span class="comment">;   - match-define
</span><span class="comment">;   - match-letrec
</span><span class="comment">;   - the ooo and ook extension in list and vector patterns
</span><span class="comment">;   - structures (easily added but they are non portable)
</span>
<span class="comment">;;; IMPLEMENTATION
</span>
<span class="comment">; The implementation is divided into layers, each layer
</span><span class="comment">; handles one aspect of the pattern matching process.
</span>
<span class="comment">; The main macro from the user perspective is the match macro.
</span><span class="comment">;   (match expr [(pattern expr ...) ...])
</span><span class="comment">; which binds the value to be matched to a variable, and leaves
</span><span class="comment">; the real work to guarded match. Match also handles the case
</span><span class="comment">; of multple patterns.
</span>
<span class="comment">; The macro guarded-match
</span><span class="comment">;    (guarded-match var pattern success failure)
</span><span class="comment">; expands to success if the value bound to var matches the pattern,
</span><span class="comment">; otherwise it expands to failure.
</span><span class="comment">; Guarded-match takes care of guards and then macro calls logical-match.
</span>
<span class="comment">; The macro logical-match
</span><span class="comment">;    (logical-match var pattern success failure)
</span><span class="comment">; expands to success if the value bound to var matches the pattern,
</span><span class="comment">; otherwise it expands to failure.
</span><span class="comment">; Logical-match takes care of patterns of the form
</span><span class="comment">;   (and pattern ...)
</span><span class="comment">;   (or  pattern ...)
</span><span class="comment">;   (not pattern pattern ...)
</span><span class="comment">;   (?   expr pattern ...)
</span><span class="comment">; and then macro calls compound-match.
</span>
<span class="comment">; The macro compound-match
</span><span class="comment">;    (compound-match var pattern success failure)
</span><span class="comment">; expands to success if the value bound to var matches the pattern,
</span><span class="comment">; otherwise it expands to failure.
</span><span class="comment">; Compound-match takes care of patterns of the form
</span><span class="comment">;   (cons pattern pattern)
</span><span class="comment">;   (list pattern ...)
</span><span class="comment">;   (list-rest pattern ... pattern)
</span><span class="comment">;   (vector pattern pattern ...)
</span><span class="comment">;   (app expr pattern)
</span><span class="comment">; and then macro calls simple-match.
</span>
<span class="comment">; The macro simple-match
</span><span class="comment">;    (simple-match var pattern success failure)
</span><span class="comment">; expands to success if the value bound to var matches the pattern,
</span><span class="comment">; otherwise it expands to failure.
</span><span class="comment">; Simple-match takes care of patterns of the form
</span><span class="comment">;   (quote symbol)
</span><span class="comment">;   (quote datum)
</span><span class="comment">;   pattern-var
</span><span class="comment">;   literal
</span><span class="comment">; and possible macro calls literal-match.
</span>
<span class="comment">; The macro literal-match
</span><span class="comment">;    (literal-match var pattern success failure)
</span><span class="comment">; expands to success if the value bound to var matches the pattern,
</span><span class="comment">; otherwise it expands to failure.
</span><span class="comment">; Literal-match takes care of patterns of atoms of the form
</span><span class="comment">;   the empty list
</span><span class="comment">;   booleans
</span><span class="comment">;   strings
</span><span class="comment">;   numbers
</span><span class="comment">;   characters
</span><span class="comment">; and compound literals.
</span>
(<span class="keyword">define-syntax</span> <span class="variable">symbol??</span>
  <span class="comment">;; From Oleg's "How to write symbol? with syntax-rules.
</span>  <span class="comment">;; &lt;http://okmij.org/ftp/Scheme/macro-symbol-p.txt&gt;
</span>  (<span class="keyword">syntax-rules</span> ()
    ((<span class="variable">symbol??</span> (<span class="variable">x</span> . <span class="variable">y</span>) <span class="variable">kt</span> <span class="variable">kf</span>) <span class="variable">kf</span>)   <span class="comment">; It's a pair, not a symbol
</span>    ((<span class="variable">symbol??</span> <span class="selfeval">#</span>(<span class="variable">x</span> ...) <span class="variable">kt</span> <span class="variable">kf</span>) <span class="variable">kf</span>)   <span class="comment">; It's a vector, not a symbol
</span>    ((<span class="variable">symbol??</span> <span class="variable">maybe-symbol</span> <span class="variable">kt</span> <span class="variable">kf</span>)
     (<span class="keyword">let-syntax</span>
         ((<span class="variable">test</span>
      (<span class="keyword">syntax-rules</span> ()
        ((<span class="variable">test</span> <span class="variable">maybe-symbol</span> <span class="variable">t</span> <span class="variable">f</span>) <span class="variable">t</span>)
        ((<span class="variable">test</span> <span class="variable">x</span> <span class="variable">t</span> <span class="variable">f</span>) <span class="variable">f</span>))))
       (<span class="variable">test</span> <span class="variable">abracadabra</span> <span class="variable">kt</span> <span class="variable">kf</span>)))))
(<span class="keyword">define</span> (<span class="variable">literal?</span> <span class="variable">datum</span>)
  (<span class="keyword">or</span> (<span class="builtin">string?</span> <span class="variable">datum</span>)
      (<span class="builtin">number?</span> <span class="variable">datum</span>)
      (<span class="builtin">char?</span> <span class="variable">datum</span>)
      (<span class="builtin">null?</span> <span class="variable">datum</span>)
      (<span class="builtin">boolean?</span> <span class="variable">datum</span>)))
(<span class="keyword">define-syntax</span> <span class="variable">literal-match</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">var</span> () <span class="variable">success</span> <span class="variable">failure</span>)        (<span class="keyword">if</span> (<span class="builtin">null?</span> <span class="variable">var</span>)  <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="selfeval">#t</span> <span class="variable">success</span> <span class="variable">failure</span>)        (<span class="keyword">if</span> (<span class="builtin">eq?</span> <span class="variable">var</span> <span class="selfeval">#t</span>) <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="selfeval">#f</span> <span class="variable">success</span> <span class="variable">failure</span>)        (<span class="keyword">if</span> (<span class="builtin">eq?</span> <span class="variable">var</span> <span class="selfeval">#f</span>) <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">literal</span> <span class="variable">success</span> <span class="variable">failure</span>)   (<span class="keyword">if</span> (<span class="keyword">and</span> (<span class="variable">literal?</span> <span class="variable">var</span>)
                                               (<span class="builtin">equal?</span> <span class="variable">var</span> <span class="variable">literal</span>))
                                          <span class="variable">success</span>
                                          <span class="variable">failure</span>)]))
(<span class="keyword">define-syntax</span> <span class="variable">simple-match</span>
  <span class="comment">; (simple-match var pattern success failure)
</span>  <span class="comment">;     If the value bound to var matches pattern then the
</span>  <span class="comment">;     expression expands into a let binding the pattern variables
</span>  <span class="comment">;     in the pattern to the matched (sub)values, success becomes the
</span>  <span class="comment">;     body of the let. Otherwise the macro call expands to failure.
</span>  (<span class="keyword">syntax-rules</span> (<span class="keyword">quote</span>)
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">quote</span> <span class="variable">symbol/datum</span>)     <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="keyword">if</span> ((<span class="variable">symbol??</span> <span class="variable">symbol/datum</span> <span class="builtin">eq?</span> <span class="builtin">equal?</span>) <span class="variable">var</span> <span class="keyword">'</span><span class="variable">symbol/datum</span>)
                                                          <span class="variable">success</span>
                                                          <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">name/literal</span>             <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">symbol??</span> <span class="variable">name/literal</span>
                                                                <span class="comment">; pattern variable
</span>                                                                (<span class="keyword">let</span> ([<span class="variable">name/literal</span> <span class="variable">var</span>])
                                                                  <span class="variable">success</span>)
                                                                <span class="comment">; literal
</span>                                                                (<span class="variable">literal-match</span> <span class="variable">var</span> <span class="variable">name/literal</span> <span class="variable">success</span> <span class="variable">failure</span>))]))
(<span class="keyword">define-syntax</span> <span class="variable">compound-match</span>
  (<span class="keyword">syntax-rules</span> (<span class="builtin">cons</span> <span class="builtin">list</span> <span class="variable">list-rest</span> <span class="variable">app</span> <span class="builtin">vector</span>)
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">cons</span> <span class="variable">p1</span> <span class="variable">p2</span>)            <span class="variable">success</span> <span class="variable">failure</span>)   (<span class="keyword">let</span> ([<span class="variable">failure-thunk</span> (<span class="keyword">lambda</span> () <span class="variable">failure</span>)])
                                                         <span class="comment">; Note: Converting failure to a failure thunk
</span>                                                         <span class="comment">;       considerably reduces the size if the
</span>                                                         <span class="comment">;       exapnded code
</span>                                                         <span class="comment">;      (at the cost of generating closures at runtime)
</span>                                                         (<span class="keyword">if</span> (<span class="builtin">pair?</span> <span class="variable">var</span>)
                                                             (<span class="variable">match</span> (<span class="builtin">car</span> <span class="variable">var</span>)
                                                               [<span class="variable">p1</span> (<span class="variable">match</span> (<span class="builtin">cdr</span> <span class="variable">var</span>)
                                                                     [<span class="variable">p2</span> <span class="variable">success</span>]
                                                                     [<span class="variable">_</span> (<span class="variable">failure-thunk</span>)])]
                                                               [<span class="variable">_</span>  (<span class="variable">failure-thunk</span>)])
                                                             (<span class="variable">failure-thunk</span>)))]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">list</span>)                   <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> () <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">list</span> <span class="variable">p1</span>)                <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> (<span class="builtin">cons</span> <span class="variable">p1</span> ()) <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">list</span> <span class="variable">p1</span> <span class="variable">p2</span> ...)         <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> (<span class="builtin">cons</span> <span class="variable">p1</span> (<span class="builtin">list</span> <span class="variable">p2</span> ...)) <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">vector</span> <span class="variable">p1</span> ...)          <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="keyword">let</span> ([<span class="variable">vector-var</span> (<span class="keyword">if</span> (<span class="builtin">vector?</span> <span class="variable">var</span>)
                                                                             (<span class="builtin">vector-&gt;list</span> <span class="variable">var</span>)
                                                                             <span class="keyword">'</span><span class="variable">failed-vector-match</span>)])
                                                         (<span class="variable">compound-match</span> <span class="variable">vector-var</span> (<span class="builtin">list</span> <span class="variable">p1</span> ...) <span class="variable">success</span> <span class="variable">failure</span>))]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="variable">list-rest</span> <span class="variable">p1</span> <span class="variable">p2</span>)        <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> (<span class="builtin">cons</span> <span class="variable">p1</span> <span class="variable">p2</span>) <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="variable">list-rest</span> <span class="variable">p1</span> <span class="variable">p2</span> <span class="variable">p3</span> ...) <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> (<span class="builtin">cons</span> <span class="variable">p1</span> (<span class="variable">list-rest</span> <span class="variable">p2</span> <span class="variable">p3</span> ...))
                                                                       <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="variable">app</span> <span class="variable">expr</span> <span class="variable">p1</span>)            <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="keyword">let</span> ([<span class="variable">new-var</span> (<span class="variable">expr</span> <span class="variable">var</span>)])
                                                        (<span class="variable">match</span> <span class="variable">new-var</span> <span class="variable">p1</span> <span class="variable">success</span> <span class="variable">failure</span>))]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">pattern</span>          <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">simple-match</span> <span class="variable">var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>)]))
(<span class="keyword">define-syntax</span> <span class="variable">logical-match</span>
  (<span class="keyword">syntax-rules</span> (<span class="keyword">and</span> <span class="keyword">or</span> <span class="builtin">not</span> <span class="variable">?</span>)
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">and</span>)            <span class="variable">success</span> <span class="variable">failure</span>)  <span class="variable">success</span>]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">and</span> <span class="variable">p1</span>)         <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> <span class="variable">p1</span> <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">and</span> <span class="variable">p1</span> <span class="variable">p2</span> ...)  <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> <span class="variable">p1</span>
                                                              (<span class="variable">logical-match</span> <span class="variable">var</span> (<span class="keyword">and</span> <span class="variable">p2</span> ...) <span class="variable">success</span> <span class="variable">failure</span>)
                                                              <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">or</span> <span class="variable">p1</span>)          <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> <span class="variable">p1</span> <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="keyword">or</span> <span class="variable">p1</span> <span class="variable">p2</span> ...)   <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> <span class="variable">p1</span> <span class="variable">success</span>
                                                              (<span class="variable">logical-match</span> <span class="variable">var</span> (<span class="keyword">or</span> <span class="variable">p2</span> ...) <span class="variable">success</span> <span class="variable">failure</span>))]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">not</span> <span class="variable">p</span>)          <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">logical-match</span> <span class="variable">var</span> <span class="variable">p</span> <span class="variable">failure</span> <span class="variable">success</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="builtin">not</span> <span class="variable">p1</span> <span class="variable">p2</span> ...)  <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">logical-match</span> <span class="variable">var</span> (<span class="keyword">and</span> (<span class="builtin">not</span> <span class="variable">p1</span>) (<span class="builtin">not</span> <span class="variable">p2</span>) ...) <span class="variable">failure</span> <span class="variable">success</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> (<span class="variable">?</span> <span class="variable">expr</span> <span class="variable">p</span> ...)   <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="keyword">if</span> <span class="variable">expr</span>
                                                  (<span class="variable">logical-match</span> <span class="variable">var</span> (<span class="keyword">and</span> <span class="variable">p</span> ...) <span class="variable">success</span> <span class="variable">failure</span>)
                                                  <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">pattern</span>          <span class="variable">success</span> <span class="variable">failure</span>)  (<span class="variable">compound-match</span> <span class="variable">var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>)]))
(<span class="keyword">define-syntax</span> <span class="variable">guarded-match</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>)          (<span class="variable">logical-match</span> <span class="variable">var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>)]
    [(<span class="variable">_</span> <span class="variable">var</span> <span class="variable">pattern</span> <span class="variable">guard</span> <span class="variable">success</span> <span class="variable">failure</span>)    (<span class="variable">guarded-match</span> <span class="variable">var</span> <span class="variable">pattern</span> (<span class="keyword">if</span> <span class="variable">guard</span> <span class="variable">success</span> <span class="variable">failure</span>) <span class="variable">failure</span>)]))
(<span class="keyword">define-syntax</span> <span class="variable">match</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">expr</span>)                                  (<span class="keyword">let</span> ([<span class="variable">v</span> <span class="variable">expr</span>])
                                                 <span class="keyword">'</span><span class="variable">no-match</span>)]
    [(<span class="variable">_</span> <span class="variable">expr</span> [<span class="variable">pattern</span> <span class="variable">template</span>]
             <span class="variable">clauses</span> ...)                      (<span class="keyword">let</span> ([<span class="variable">v</span> <span class="variable">expr</span>])
                                                 (<span class="variable">guarded-match</span> <span class="variable">v</span> <span class="variable">pattern</span>
                                                                <span class="variable">template</span>
                                                                (<span class="variable">match</span> <span class="variable">v</span> <span class="variable">clauses</span> ...)))]
    [(<span class="variable">_</span> <span class="variable">expr</span> [<span class="variable">pattern</span> <span class="variable">guard</span> <span class="variable">template</span>]
             <span class="variable">clauses</span> ...)                      (<span class="keyword">let</span> ([<span class="variable">v</span> <span class="variable">expr</span>])
                                                 (<span class="variable">guarded-match</span> <span class="variable">v</span> <span class="variable">pattern</span> <span class="variable">guard</span>
                                                                <span class="variable">template</span>
                                                                (<span class="variable">match</span> <span class="variable">v</span> <span class="variable">clauses</span> ...)))]))
(<span class="keyword">define-syntax</span> <span class="variable">match-lambda</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> (<span class="variable">pat</span> <span class="variable">expr</span> ...) ...)         (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="variable">match</span> <span class="variable">x</span> (<span class="variable">pat</span> <span class="variable">expr</span> ...) ...))]))
(<span class="keyword">define-syntax</span> <span class="variable">match-lambda*</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> (<span class="variable">pat</span> <span class="variable">expr</span> ...) ...)         (<span class="keyword">lambda</span> <span class="variable">x</span>   (<span class="variable">match</span> <span class="variable">x</span> (<span class="variable">pat</span> <span class="variable">expr</span> ...) ...))]))
(<span class="keyword">define-syntax</span> <span class="variable">match-let*</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> () <span class="variable">body</span> ...)                                (<span class="keyword">let</span> () <span class="variable">body</span> ...)]
    [(<span class="variable">_</span> ((<span class="variable">pat</span> <span class="variable">expr</span>)) <span class="variable">body</span> ...)                      ((<span class="variable">match-lambda</span> (<span class="variable">pat</span> <span class="variable">body</span> ...)) <span class="variable">expr</span>)]
    [(<span class="variable">_</span> ((<span class="variable">pat</span> <span class="variable">expr</span>) (<span class="variable">pat2</span> <span class="variable">expr2</span>) ...) <span class="variable">body</span> ...)     (<span class="variable">match-let*</span> ([<span class="variable">pat</span> <span class="variable">expr</span>])
                                                      (<span class="variable">match-let*</span>
                                                          ((<span class="variable">pat2</span> <span class="variable">expr2</span>) ...)
                                                        <span class="variable">body</span> ...))]))
(<span class="keyword">define-syntax</span> <span class="variable">match-let</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> () <span class="variable">body</span> ...)               (<span class="keyword">let</span> () <span class="variable">body</span> ...)]
    [(<span class="variable">_</span> ((<span class="variable">pat</span> <span class="variable">expr</span>) ...) <span class="variable">body</span> ...) (<span class="variable">match-let*</span> ([(<span class="builtin">list</span> <span class="variable">pat</span> ...) (<span class="builtin">list</span> <span class="variable">expr</span> ...)]) <span class="variable">body</span> ...)]))
(<span class="keyword">define-syntax</span> <span class="variable">match-define-values-helper</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> (<span class="variable">id</span> ...) (<span class="variable">pat</span>) (<span class="variable">expr</span>))                   (<span class="variable">match</span> <span class="variable">expr</span>
                                                   [<span class="variable">pat</span>  (<span class="builtin">values</span> <span class="variable">id</span> ...)])]
    [(<span class="variable">_</span> (<span class="variable">id</span> ...) (<span class="variable">pat</span> . <span class="variable">pats</span>) (<span class="variable">expr</span> . <span class="variable">exprs</span>))    (<span class="variable">match</span> <span class="variable">expr</span>
                                                   [<span class="variable">pat</span>  (<span class="builtin">values</span> <span class="variable">id</span> ...)]
                                                   [<span class="keyword">else</span> (<span class="variable">match-define-values-helper</span> (<span class="variable">id</span> ...) <span class="variable">pats</span> <span class="variable">exprs</span>)])]))
(<span class="keyword">define-syntax</span> <span class="variable">match-define-values</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> (<span class="variable">id</span> ...) [<span class="variable">pat</span> <span class="variable">expr</span>])                   (<span class="variable">define-values</span> (<span class="variable">id</span> ...)
                                                 (<span class="variable">match-define-values-helper</span> (<span class="variable">id</span> ...) (<span class="variable">pat</span>) (<span class="variable">expr</span>)))]
    [(<span class="variable">_</span> (<span class="variable">id</span> ...) [<span class="variable">pat</span> <span class="variable">expr</span>] ...)               (<span class="variable">define-values</span> (<span class="variable">id</span> ...)
                                                 (<span class="variable">match-define-values-helper</span> (<span class="variable">id</span> ...) (<span class="variable">pat</span> ...) (<span class="variable">expr</span> ...)))]))
<span class="comment">;;;
</span><span class="comment">;;; TEST
</span><span class="comment">;;;
</span>
(<span class="keyword">define-syntax</span> <span class="variable">test-simple</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">value</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>) (<span class="keyword">let</span> ([<span class="variable">test-simple-var</span> <span class="variable">value</span>])
                                        (<span class="variable">simple-match</span> <span class="variable">test-simple-var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>))]))
<span class="keyword">'</span><span class="variable">SIMPLE</span>
(<span class="variable">test-simple</span> <span class="keyword">'</span>() () <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">test-simple</span> <span class="selfeval">1</span> <span class="selfeval">1</span> <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">test-simple</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="keyword">'</span><span class="variable">fail</span> <span class="keyword">'</span><span class="variable">ok</span>)
(<span class="variable">test-simple</span> <span class="keyword">'</span><span class="variable">foo</span> <span class="keyword">'</span><span class="variable">foo</span> <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">test-simple</span> <span class="keyword">'</span><span class="variable">foo</span> <span class="keyword">'</span><span class="variable">bar</span> <span class="keyword">'</span><span class="variable">fail</span> <span class="keyword">'</span><span class="variable">ok</span>)
(<span class="keyword">define-syntax</span> <span class="variable">test-compound</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">value</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>) (<span class="keyword">let</span> ([<span class="variable">test-compund-var</span> <span class="variable">value</span>])
                                        (<span class="variable">compound-match</span> <span class="variable">test-compund-var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>))]))
<span class="keyword">'</span><span class="variable">COMPOUND</span>
(<span class="variable">test-compound</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">"foo"</span>) (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">"foo"</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">test-compound</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>) (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>) (<span class="keyword">if</span> (<span class="builtin">=</span> <span class="variable">a</span> <span class="selfeval">1</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail1</span>) <span class="keyword">'</span><span class="variable">fail2</span>)
(<span class="variable">test-compound</span> (<span class="builtin">list</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">3</span>) (<span class="builtin">list</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="builtin">+</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) <span class="selfeval">6</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail1</span>) <span class="keyword">'</span><span class="variable">fail2</span>)
(<span class="variable">test-compound</span> (<span class="builtin">vector</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">3</span>) (<span class="builtin">vector</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="builtin">+</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) <span class="selfeval">6</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail1</span>) <span class="keyword">'</span><span class="variable">fail2</span>)
(<span class="keyword">define-syntax</span> <span class="variable">test-logical</span>
  (<span class="keyword">syntax-rules</span> ()
    [(<span class="variable">_</span> <span class="variable">value</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>) (<span class="keyword">let</span> ([<span class="variable">test-logical-var</span> <span class="variable">value</span>])
                                        (<span class="variable">logical-match</span> <span class="variable">test-logical-var</span> <span class="variable">pattern</span> <span class="variable">success</span> <span class="variable">failure</span>))]))
<span class="keyword">'</span><span class="variable">LOGICAL</span>
(<span class="variable">test-logical</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
              (<span class="keyword">and</span> (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>) (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="variable">c</span>) (<span class="builtin">cons</span> <span class="variable">d</span> <span class="selfeval">2</span>))
              (<span class="keyword">if</span> (<span class="builtin">equal?</span> (<span class="builtin">list</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span> <span class="variable">d</span>)
                          (<span class="builtin">list</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">2</span> <span class="selfeval">1</span>))
                  <span class="keyword">'</span><span class="variable">ok</span>
                  <span class="keyword">'</span><span class="variable">fail1</span>)
              <span class="keyword">'</span><span class="variable">fail2</span>)
(<span class="variable">test-logical</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
              (<span class="keyword">or</span> <span class="selfeval">1</span> <span class="selfeval">"foo"</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">3</span>) (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>) <span class="selfeval">#\c</span>)
              <span class="keyword">'</span><span class="variable">ok</span>
              <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">test-logical</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
              (<span class="builtin">not</span> (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>))
              <span class="keyword">'</span><span class="variable">fail</span>
              <span class="keyword">'</span><span class="variable">ok</span>)
(<span class="variable">test-logical</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
              (<span class="builtin">not</span> (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>))
              <span class="keyword">'</span><span class="variable">fail</span>
              <span class="keyword">'</span><span class="variable">ok</span>)
(<span class="variable">test-logical</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
              (<span class="builtin">not</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">"foo"</span> (<span class="builtin">cons</span> <span class="selfeval">3</span> <span class="selfeval">4</span>))
              <span class="keyword">'</span><span class="variable">ok</span>
              <span class="keyword">'</span><span class="variable">fail</span>)
<span class="keyword">'</span><span class="variable">GUARDED</span>
(<span class="variable">guarded-match</span> (<span class="builtin">cons</span> <span class="selfeval">42</span> <span class="selfeval">2</span>) (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>) (<span class="builtin">even?</span> <span class="variable">a</span>) <span class="keyword">'</span><span class="variable">ok</span>   <span class="keyword">'</span><span class="variable">fail</span>)
(<span class="variable">guarded-match</span> (<span class="builtin">cons</span> <span class="selfeval">43</span> <span class="selfeval">2</span>) (<span class="builtin">cons</span> <span class="variable">a</span> <span class="variable">b</span>) (<span class="builtin">even?</span> <span class="variable">a</span>) <span class="keyword">'</span><span class="variable">fail</span> <span class="keyword">'</span><span class="variable">ok</span>)
<span class="keyword">'</span><span class="variable">FULL</span>
(<span class="variable">match</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)
           [()         <span class="keyword">'</span><span class="variable">empty</span>]
           [(<span class="builtin">cons</span> <span class="selfeval">1</span> <span class="variable">b</span>) (<span class="keyword">if</span> (<span class="builtin">=</span> <span class="variable">b</span> <span class="selfeval">2</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)])
(<span class="variable">match</span> (<span class="builtin">cons</span> <span class="selfeval">1</span> (<span class="builtin">cons</span> <span class="selfeval">2</span> <span class="selfeval">3</span>))
            [()         <span class="keyword">'</span><span class="variable">empty</span>]
            [(<span class="builtin">cons</span> <span class="selfeval">1</span> (<span class="builtin">cons</span> <span class="selfeval">2</span> <span class="variable">b</span>)) (<span class="keyword">if</span> (<span class="builtin">=</span> <span class="variable">b</span> <span class="selfeval">3</span>) <span class="keyword">'</span><span class="variable">ok</span> <span class="keyword">'</span><span class="variable">fail</span>)])
(<span class="variable">match</span> <span class="keyword">'</span><span class="variable">foo</span>
            [<span class="keyword">'</span><span class="variable">foo</span> <span class="keyword">'</span><span class="variable">ok</span>]
            [<span class="keyword">else</span> <span class="keyword">'</span><span class="variable">fail</span>])
(<span class="variable">match</span> <span class="keyword">'</span><span class="variable">foo</span>
            [<span class="keyword">'</span><span class="variable">bar</span> <span class="keyword">'</span><span class="variable">fail</span>]
            [<span class="keyword">else</span> <span class="keyword">'</span><span class="variable">ok</span>])
<span class="keyword">'</span><span class="variable">MATCH-LET*</span>
(<span class="variable">match-let*</span> ([(<span class="builtin">list</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span>)    (<span class="builtin">list</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">3</span>)]
             [(<span class="builtin">vector</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>)  (<span class="builtin">vector</span> <span class="selfeval">4</span> <span class="selfeval">5</span> <span class="selfeval">6</span>)])
  (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="builtin">+</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) <span class="selfeval">21</span>)
      <span class="keyword">'</span><span class="variable">ok</span>
      <span class="keyword">'</span><span class="variable">fail</span>))
(<span class="variable">match-let*</span> ([(<span class="builtin">list</span> <span class="variable">x</span> <span class="variable">y</span>)    (<span class="builtin">list</span> <span class="selfeval">1</span> <span class="selfeval">2</span>)]
            [(<span class="builtin">vector</span> <span class="variable">a</span> <span class="variable">b</span>)   (<span class="builtin">vector</span> <span class="selfeval">3</span> <span class="variable">x</span>)])
  (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="builtin">+</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">a</span> <span class="variable">b</span>) <span class="selfeval">7</span>)
      <span class="keyword">'</span><span class="variable">ok</span>
      <span class="keyword">'</span><span class="variable">fail</span>))
<span class="keyword">'</span><span class="variable">MATCH-LET</span>
(<span class="variable">match-let</span> ([(<span class="builtin">list</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span>)    (<span class="builtin">list</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">3</span>)]
            [(<span class="builtin">vector</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>)  (<span class="builtin">vector</span> <span class="selfeval">4</span> <span class="selfeval">5</span> <span class="selfeval">6</span>)])
  (<span class="keyword">if</span> (<span class="builtin">=</span> (<span class="builtin">+</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span> <span class="variable">a</span> <span class="variable">b</span> <span class="variable">c</span>) <span class="selfeval">21</span>)
      <span class="keyword">'</span><span class="variable">ok</span>
      <span class="keyword">'</span><span class="variable">fail</span>))
<span class="keyword">'</span><span class="variable">MATCH-DEFINE-VALUES</span>
(<span class="variable">match-define-values</span> (<span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span>)
                     [(<span class="builtin">vector</span> <span class="variable">x</span> (<span class="builtin">list</span> <span class="variable">y</span> <span class="variable">z</span>))  (<span class="builtin">list</span> <span class="selfeval">1</span> (<span class="builtin">list</span> <span class="selfeval">2</span> <span class="selfeval">3</span>))]
                     [(<span class="builtin">list</span> <span class="variable">x</span> (<span class="builtin">list</span> <span class="variable">y</span> <span class="variable">z</span>))    (<span class="builtin">list</span> <span class="selfeval">1</span> (<span class="builtin">list</span> <span class="selfeval">2</span> <span class="selfeval">3</span>))])
(<span class="builtin">list</span> <span class="variable">x</span> <span class="variable">y</span> <span class="variable">z</span>)
</pre>
</div>
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
<p />
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/JensAxelSoegaard">JensAxelSoegaard</a> - 23 May 2007
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Other </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left">  </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
