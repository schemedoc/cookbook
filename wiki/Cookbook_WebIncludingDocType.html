<div id="contentbox">
 <div class="widget">
  <p />
<h2><a name="Including_A_DOCTYPE_Declaration_"> </a> Including A DOCTYPE Declaration With A Servlet Response </h2>
<p />
<h3>
  <a name="Problem"> Problem </a>
</h3>
<p />
You want to include a DOCTYPE declaration in your servlet response, whilst retaining the ease-of-use of the X-expression format.
<p />
<h3>
  <a name="Solution"> Solution </a>
</h3>
<p />
The following function takes an X-expression and returns a servlet response that contains the response and the XHTML transitional DOCTYPE.
<p />
<div class="scheme">
  <pre><span class="comment">;; make-xhtml-response : xexpr -&gt; (list-of string)
</span>(<span class="keyword">define</span> (<span class="variable">make-xhtml-response</span> <span class="variable">xexpr</span>)
  (<span class="builtin">list</span> <span class="selfeval">"text/html"</span>
        <span class="selfeval">"&lt;!DOCTYPE html
           PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"
           \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"&gt;"</span>
        (<span class="variable">xexpr-&gt;string</span> <span class="variable">xexpr</span>)))
</pre>
</div>
<p />
<h3>
  <a name="Discussion"> Discussion </a>
</h3>
<p />
A servlet can return three different types of responses:
<p />
<ul>
<li> An X-expression, the most convenient type of response to use.
</li>
<li> A list of strings.  The first string is the MIME type, the rest the content.
</li>
<li> A response constructed using <code>make-response/full</code>
</li>
</ul>
<p />
The code above uses the second method to prepend the XHTML Transitional DOCTYPE declaration to an X-expression response.  The response is given the text/html MIME type.  This is not recommended by the W3C, but Internet Explorer is not standards compliant and fails to correctly process file with the recommended MIME type.
<p />
The documentation for X-expressions says they represent the "interesting" part of an XML document.  This is true if you aren't interested in XML standards, but the increasing use of XML on the web means that applications have to be aware of the additional requirements of XML.  In particular Internet Explorer 6 reverts to the broken Internet Explorer 5 rendering model if HTML documents don't have a DOCTYPE (<span style="background : #FFFFCE;">
  <font color="#0000FF">FireFox</font>
</span><a href="/edit/Cookbook/FireFox?topicparent=Cookbook.WebIncludingDocType">?</a> of course does the right thing).
<p />
The XML library can represent a DOCTYPE, though the X-expression format cannot.  To add a DOCTYPE to an X-expression by converting it to the structure representation defined in the XML library you could use the following function:
<p />
<div class="scheme">
  <pre><span class="comment">;; xexpr-&gt;xhtml : x-expression -&gt; document
</span><span class="comment">;;
</span><span class="comment">;; Convert an X-expression to an XML document representing XHTML
</span>(<span class="keyword">define</span> (<span class="variable">xexpr-&gt;xhtml</span> <span class="variable">xexpr</span>)
  (<span class="variable">make-document</span>
    (<span class="variable">make-prolog</span> <span class="keyword">'</span>()
                 (<span class="variable">make-document-type</span>
                  <span class="keyword">'</span><span class="variable">html</span>
                  (<span class="variable">make-external-dtd/public</span>
                   <span class="selfeval">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>
                   <span class="selfeval">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>)
                  <span class="selfeval">#f</span>))
    (<span class="variable">xexpr-&gt;xml</span> <span class="variable">xexpr</span>)))
</pre>
</div>
<p />
<p />
<hr>
<p />
<h3>
  <a name="Comments_about_this_recipe"> Comments about this recipe </a>
</h3>
<p />
The thing is, if you're going to use XHTML, you're probably going to need fine control over the HTTP headers as well. According to the W3C, there are strict requirements about the MIME type reported by the web browser for XHTML. The proper MIME type is <code>application/xhtml+xml</code>, but unfortunately not all browsers support this MIME type. The solution is to take a look at the <code>"Accept"</code> header of the request and see if the browser supports it, and otherwise use <code>text/html</code>.
<p />
<div class="scheme">
  <pre>(<span class="keyword">require</span> (<span class="variable">lib</span> <span class="selfeval">"servlet.ss"</span> <span class="selfeval">"web-server"</span>)
         (<span class="variable">lib</span> <span class="selfeval">"response.ss"</span> <span class="selfeval">"web-server"</span>)
         (<span class="variable">lib</span> <span class="selfeval">"etc.ss"</span>)
         (<span class="variable">lib</span> <span class="selfeval">"string.ss"</span>)
         (<span class="variable">lib</span> <span class="selfeval">"xml.ss"</span> <span class="selfeval">"xml"</span>))
(<span class="keyword">define</span> (<span class="variable">accepted-mime-types</span> <span class="variable">request</span>)
  (<span class="keyword">with-handlers</span> ([<span class="variable">exn?</span> (<span class="keyword">lambda</span> (<span class="variable">exn</span>) <span class="variable">null</span>)])
    (<span class="keyword">let</span> ([<span class="variable">header</span> (<span class="variable">extract-binding/single</span> <span class="keyword">'</span><span class="variable">accept</span> (<span class="variable">request-headers</span> <span class="variable">request</span>))])
      (<span class="variable">regexp-split</span> <span class="selfeval">#rx</span><span class="selfeval">",[ \t\r\n]*"</span>
                    (<span class="keyword">if</span> (<span class="variable">bytes?</span> <span class="variable">header</span>)
                        (<span class="variable">bytes-&gt;string/latin-1</span> <span class="variable">header</span>)
                        <span class="variable">header</span>)))))
(<span class="keyword">define</span> (<span class="variable">xhtml-mime-type</span> <span class="variable">request</span>)
  (<span class="keyword">if</span> (<span class="keyword">and</span> <span class="variable">request</span> (<span class="builtin">member</span> <span class="selfeval">"application/xhtml+xml"</span> (<span class="variable">accepted-mime-types</span> <span class="variable">request</span>)))
      <span class="selfeval">#</span><span class="selfeval">"application/xhtml+xml"</span>
      <span class="selfeval">#</span><span class="selfeval">"text/html"</span>))
(<span class="keyword">define</span> <span class="variable">doctype</span>
  (<span class="builtin">string-append</span> <span class="selfeval">"&lt;!DOCTYPE html "</span>
                 <span class="selfeval">"PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" "</span>
                 <span class="selfeval">"\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"&gt;\n"</span>))
(<span class="keyword">define</span> <span class="variable">make-response/xhtml</span>
  (<span class="variable">opt-lambda</span> (<span class="variable">xexpr</span> [<span class="variable">request</span> <span class="selfeval">#f</span>])
    (<span class="variable">make-response/full</span>
     <span class="selfeval">200</span>
     <span class="selfeval">"Okay"</span>
     (<span class="variable">current-seconds</span>)
     (<span class="variable">xhtml-mime-type</span> <span class="variable">request</span>)
     <span class="variable">null</span>
     (<span class="builtin">list</span> <span class="variable">doctype</span> (<span class="variable">xexpr-&gt;string</span> <span class="variable">xexpr</span>)))))
</pre>
</div>
<p />
I should probably make this into a <a href="/Cookbook/PLaneT">PLaneT</a> package.
<p />
See also:
<p />
<ul>
<li> <a href="http://www.xml.com/pub/a/2003/03/19/dive-into-xml.html" target="_top">http://www.xml.com/pub/a/2003/03/19/dive-into-xml.html</a>
</li>
<li> <a href="http://www.w3.org/TR/xhtml-media-types" target="_top">http://www.w3.org/TR/xhtml-media-types</a>
</li>
</ul>
<p />
-- <a href="/Main/DaveHerman">DaveHerman</a> - 30 Sep 2005
<p />
Okay, I've added a new <a href="/Cookbook/PLaneT">PLaneT</a> package for this. Use:
<p />
<div class="scheme">
  <pre>(<span class="keyword">require</span> (<span class="variable">planet</span> <span class="selfeval">"xhtml.ss"</span> (<span class="selfeval">"dherman"</span> <span class="selfeval">"xhtml.plt"</span> <span class="selfeval">1</span> <span class="selfeval">1</span>)))
</pre>
</div>
<p />
-- <a href="/Main/DaveHerman">DaveHerman</a> - 30 Sep 2005
<p />
<h3>
  <a name="Contributors"> Contributors </a>
</h3>
<p />
-- <a href="/Main/NoelWelsh">NoelWelsh</a> - 22 Nov 2004
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left"> <a href="/Cookbook/WebRecipes">WebRecipes</a> </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
