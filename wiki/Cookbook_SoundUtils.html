<div id="contentbox">
 <div class="widget">
  <div class="scheme">
  <pre><span class="comment">;;uses swindle and PLT Scheme
</span>
<span class="comment">;;some constants - rates in Hz and as aiff bytestrings
</span>(<span class="keyword">define</span> <span class="variable">rate44kHz</span> (<span class="builtin">cons</span> <span class="selfeval">44100</span> (<span class="variable">bytes</span> <span class="selfeval">#xAC</span> <span class="selfeval">#x44</span> <span class="selfeval">#x00</span> <span class="selfeval">#x00</span>)))
(<span class="keyword">define</span> <span class="variable">rate22kHz</span> (<span class="builtin">cons</span> <span class="selfeval">22255</span> (<span class="variable">bytes</span> <span class="selfeval">#x56</span> <span class="selfeval">#xEE</span> <span class="selfeval">#x8B</span> <span class="selfeval">#xA3</span>)))
(<span class="keyword">define</span> <span class="variable">A440</span> <span class="selfeval">440</span>) <span class="comment">;ISO
</span>(<span class="keyword">define</span> <span class="variable">A480</span> <span class="selfeval">480</span>) <span class="comment">;Bach organ
</span>
<span class="comment">;;useful
</span>(<span class="keyword">define</span> (<span class="variable">linear-pitch-space</span> <span class="variable">p</span> <span class="variable">&amp;opt</span> (<span class="variable">middleA</span> <span class="variable">A440</span>))
  (<span class="keyword">define</span> (<span class="variable">log2</span> <span class="variable">n</span>) (<span class="builtin">/</span> (<span class="builtin">log</span> <span class="variable">n</span>) (<span class="builtin">log</span> <span class="selfeval">2</span>)))
  (<span class="builtin">expt</span> <span class="selfeval">2</span>
        (<span class="builtin">+</span> (<span class="builtin">/</span> (<span class="builtin">-</span> <span class="variable">p</span> <span class="selfeval">69</span>)
              <span class="selfeval">12</span>)
           (<span class="variable">log2</span> <span class="variable">middleA</span>))))
<span class="comment">;;-1&lt;x&lt;1 to 16 bit int
</span>(<span class="keyword">define</span> (<span class="variable">sample-to-bytes</span> <span class="variable">x</span>)
  (<span class="variable">integer-&gt;integer-bytes</span> (<span class="builtin">inexact-&gt;exact</span> (<span class="builtin">floor</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="selfeval">32000</span>))) <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>))
<span class="comment">;;pack data into an IFF chunk
</span>(<span class="keyword">define</span> (<span class="variable">enchunk</span> <span class="variable">ID</span> <span class="variable">buffer</span> <span class="variable">&amp;opt</span> (<span class="variable">prefix</span> (<span class="variable">bytes</span>)))
  (<span class="keyword">let*</span> ((<span class="variable">l</span> (<span class="builtin">+</span> (<span class="variable">bytes-length</span> <span class="variable">buffer</span>)
               (<span class="variable">bytes-length</span> <span class="variable">prefix</span>)))
         (<span class="variable">nobytes</span> (<span class="variable">bytes</span>))
         (<span class="variable">padded</span> (<span class="keyword">if</span> (<span class="builtin">odd?</span> <span class="variable">l</span>)
                     (<span class="builtin">+</span> <span class="selfeval">1</span> <span class="variable">l</span>)
                     <span class="variable">l</span>)))
    (<span class="keyword">if</span> (<span class="builtin">eq?</span> (<span class="builtin">string-length</span> <span class="variable">ID</span>) <span class="selfeval">4</span>)
        (<span class="variable">bytes-append</span> (<span class="variable">string-&gt;bytes/locale</span> <span class="variable">ID</span>)
                      (<span class="variable">integer-&gt;integer-bytes</span> <span class="variable">padded</span> <span class="selfeval">4</span> <span class="selfeval">#f</span> <span class="selfeval">#t</span>)
                      (<span class="keyword">if</span> <span class="variable">prefix</span> <span class="variable">prefix</span> <span class="variable">nobytes</span>)
                      <span class="variable">buffer</span>
                      (<span class="keyword">if</span> (<span class="builtin">odd?</span> <span class="variable">l</span>) (<span class="variable">bytes</span> <span class="selfeval">0</span>) <span class="variable">nobytes</span>))
        (<span class="variable">error</span> <span class="selfeval">"ID must be 4 characters long!"</span>))))
<span class="comment">;;make a buffer of sample frames based on an operator of length t
</span>(<span class="keyword">define</span> (<span class="variable">op-&gt;buffer</span> <span class="variable">operator</span> <span class="variable">t</span> <span class="variable">&amp;opt</span> (<span class="variable">rate</span> <span class="variable">rate44kHz</span>))
  (<span class="keyword">let</span> ((<span class="variable">buffer</span> (<span class="variable">make-bytes</span> (<span class="builtin">*</span> <span class="selfeval">2</span>
                               (<span class="builtin">+</span> <span class="selfeval">1</span> (<span class="builtin">*</span> <span class="variable">t</span> (<span class="builtin">car</span> <span class="variable">rate</span>))))))
        (<span class="variable">end</span> <span class="variable">t</span>)
        (<span class="variable">inc</span> (<span class="builtin">/</span> <span class="selfeval">1</span> (<span class="builtin">car</span> <span class="variable">rate</span>))))
    (<span class="keyword">let</span> <span class="variable">loop</span> ((<span class="variable">x</span> <span class="selfeval">0</span>)
               (<span class="variable">byteoffset</span> <span class="selfeval">0</span>))
      (<span class="keyword">if</span> (<span class="builtin">&gt;</span> <span class="variable">x</span> <span class="variable">end</span>)
          <span class="variable">buffer</span>
          (<span class="keyword">begin</span> (<span class="variable">bytes-copy!</span> <span class="variable">buffer</span>
                              <span class="variable">byteoffset</span>
                              (<span class="variable">sample-to-bytes</span> (<span class="variable">operator</span> <span class="variable">x</span>)))
                 (<span class="variable">loop</span> (<span class="builtin">+</span> <span class="variable">x</span> <span class="variable">inc</span>) (<span class="builtin">+</span> <span class="variable">byteoffset</span> <span class="selfeval">2</span>)))))))
<span class="comment">;;buffer to aiff bytestring
</span>(<span class="keyword">define</span> (<span class="variable">buffer-&gt;aiff</span> <span class="variable">bitstream</span> <span class="variable">&amp;opt</span> (<span class="variable">rate</span> <span class="variable">rate44kHz</span>))
  (<span class="keyword">let</span> ((<span class="variable">frames</span> (<span class="builtin">/</span> (<span class="variable">bytes-length</span> <span class="variable">bitstream</span>) <span class="selfeval">2</span>)))
    <span class="comment">;;FORM chunk contains other chunks
</span>    (<span class="variable">enchunk</span> <span class="selfeval">"FORM"</span>
             (<span class="variable">bytes-append</span>
              <span class="comment">;COMMon block
</span>              (<span class="variable">enchunk</span> <span class="selfeval">"COMM"</span>
                       (<span class="variable">bytes-append</span>
                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="selfeval">1</span> <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>) <span class="comment">;channels (mono)
</span>                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="variable">frames</span> <span class="selfeval">4</span> <span class="selfeval">#f</span> <span class="selfeval">#t</span>) <span class="comment">;sample frames (16)
</span>                        (<span class="variable">integer-&gt;integer-bytes</span> <span class="selfeval">16</span> <span class="selfeval">2</span> <span class="selfeval">#t</span> <span class="selfeval">#t</span>) <span class="comment">;bitwidth
</span>                        (<span class="variable">bytes</span> <span class="selfeval">#x40</span> <span class="selfeval">#x0E</span>) <span class="comment">;no idea
</span>                        (<span class="builtin">cdr</span> <span class="variable">rate</span>) <span class="comment">;framerate
</span>                        (<span class="variable">bytes</span> <span class="selfeval">0</span> <span class="selfeval">0</span> <span class="selfeval">0</span> <span class="selfeval">0</span>))) <span class="comment">;yet more WTFery.
</span>              <span class="comment">;Sound data block
</span>              (<span class="variable">enchunk</span> <span class="selfeval">"SSND"</span>
                       <span class="variable">bitstream</span>
                       (<span class="variable">make-bytes</span> <span class="selfeval">8</span> <span class="selfeval">0</span>))) <span class="comment">;;quick hack to ignore some unused settings
</span>             <span class="comment">;;Name FORM type
</span>             (<span class="variable">string-&gt;bytes/locale</span> <span class="selfeval">"AIFF"</span>))))
<span class="comment">;;
</span><span class="comment">;;Some operators
</span><span class="comment">;;
</span>
<span class="comment">;;Sinewaves
</span>(<span class="keyword">define</span> (<span class="variable">sinewave</span> <span class="variable">freq</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="builtin">sin</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="variable">freq</span> <span class="selfeval">6.2832</span>))))
<span class="comment">;;whitenoise
</span>(<span class="keyword">define</span> (<span class="variable">noise</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="variable">random</span>)))
<span class="comment">;;VCA
</span>(<span class="keyword">define</span> (<span class="variable">ampmod</span> <span class="variable">signal</span> <span class="variable">mod</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>) (<span class="builtin">*</span> (<span class="variable">signal</span> <span class="variable">x</span>)
                 (<span class="variable">mod</span> <span class="variable">x</span>))))
<span class="comment">;;half-wave
</span>(<span class="keyword">define</span> (<span class="variable">half-wave</span> <span class="variable">op</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="keyword">let</span> ((<span class="variable">b</span> (<span class="variable">op</span> <span class="variable">x</span>)))
      (<span class="keyword">if</span> (<span class="builtin">&gt;</span> <span class="variable">b</span> <span class="selfeval">0</span>) <span class="variable">b</span> <span class="selfeval">0</span>))))
<span class="comment">;;FM
</span>(<span class="keyword">define</span> (<span class="variable">FMoperator</span> <span class="variable">freq</span> <span class="variable">modulation</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="builtin">sin</span> (<span class="builtin">+</span> (<span class="builtin">*</span> <span class="variable">x</span> <span class="variable">freq</span> <span class="selfeval">6.2832</span>)
            (<span class="variable">modulation</span> <span class="variable">x</span>)))))
<span class="comment">;;Mix sound sources
</span>(<span class="keyword">define</span> (<span class="variable">mix</span> <span class="variable">&amp;rest</span> <span class="variable">sources</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="builtin">/</span> (<span class="variable">foldl</span> (<span class="keyword">lambda</span> (<span class="variable">operation</span> <span class="variable">sum</span>)
                (<span class="builtin">+</span> <span class="variable">sum</span>
                   (<span class="variable">operation</span> <span class="variable">x</span>)))
              <span class="selfeval">0</span>
              <span class="variable">sources</span>)
       (<span class="builtin">length</span> <span class="variable">sources</span>))))
<span class="comment">;;Amplitude tweak. Will clip cleanly if overdriven.
</span>(<span class="keyword">define</span> (<span class="variable">amp</span> <span class="variable">a</span> <span class="variable">op</span>)
  (<span class="keyword">lambda</span> (<span class="variable">x</span>)
    (<span class="keyword">let</span> ((<span class="variable">b</span> (<span class="builtin">*</span> <span class="variable">a</span> (<span class="variable">op</span> <span class="variable">x</span>))))
      (<span class="keyword">cond</span> ((<span class="builtin">&lt;</span> <span class="variable">b</span> <span class="selfeval">-1</span>) <span class="selfeval">-1</span>)
            ((<span class="builtin">&gt;</span> <span class="variable">b</span> <span class="selfeval">1</span>) <span class="selfeval">1</span>)
            (<span class="keyword">else</span> <span class="variable">b</span>)))))
<span class="comment">;;
</span><span class="comment">;;generate sound
</span><span class="comment">;;
</span>(<span class="keyword">define</span> <span class="variable">complex-sound</span> (<span class="variable">op-&gt;buffer</span> (<span class="variable">mix</span> (<span class="variable">ampmod</span> (<span class="variable">mix</span> (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">60</span>))
                                                    (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">64</span>))
                                                    (<span class="variable">sinewave</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">67</span>))) <span class="comment">;C major
</span>                                               (<span class="variable">half-wave</span> (<span class="variable">amp</span> <span class="selfeval">10</span> (<span class="variable">FMoperator</span> <span class="selfeval">8</span>
                                                                              (<span class="variable">sinewave</span> <span class="selfeval">1</span>))))) <span class="comment">;morse effect
</span>                                       (<span class="variable">amp</span> <span class="selfeval">0.3</span> (<span class="variable">ampmod</span> (<span class="variable">noise</span>)
                                                        (<span class="variable">sinewave</span> <span class="selfeval">0.08</span>))) <span class="comment">;fading white noise
</span>                                       (<span class="variable">ampmod</span>  (<span class="variable">amp</span> <span class="selfeval">10</span> (<span class="variable">FMoperator</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">58</span>)
                                                                    (<span class="variable">sinewave</span> (<span class="builtin">/</span> (<span class="variable">linear-pitch-space</span> <span class="selfeval">58</span>) <span class="selfeval">3</span>)))) <span class="comment">;distorted FM bass
</span>                                                (<span class="variable">sinewave</span> <span class="selfeval">0.01</span>))) <span class="comment">;fade in
</span>                                  <span class="selfeval">20</span>
                                  <span class="variable">rate22kHz</span>))
(<span class="builtin">with-output-to-file</span> <span class="selfeval">"test.aiff"</span>
  (<span class="variable">thunk</span> (<span class="builtin">display</span> (<span class="variable">buffer-&gt;aiff</span> <span class="variable">complex-sound</span> <span class="variable">rate22kHz</span>)))
  <span class="keyword">'</span><span class="variable">replace</span>)
</pre>
</div>
  <p />
<table border="1" cellspacing="0" cellpadding="0">
   <tr>
  <th colspan="2" align="center" bgcolor="#99CCCC"> <a href="/Cookbook/CookbookForm">CookbookForm</a> </th>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicType">TopicType</a>:</th>
  <td align="left"> Recipe </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/ParentTopic">ParentTopic</a>:</th>
  <td align="left">  </td>
</tr>
<tr>
  <th bgcolor="#99CCCC" align="right"> <a href="/Cookbook/TopicOrder">TopicOrder</a>:</th>
  <td align="left"> 999 </td>
</tr>
</table>
<p />
 </div>
</div>
